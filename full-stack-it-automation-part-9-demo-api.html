<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Livio&#39;s Dump RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Livio&#39;s Dump Atom Feed"><title data-rh="true">Full-Stack Automation Part 9 - Demo - API | Livio&#x27;s Dump</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://livio.zanol.com.br/full-stack-it-automation-part-9-demo-api"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Full-Stack Automation Part 9 - Demo - API | Livio&#x27;s Dump"><meta data-rh="true" name="description" content="Service API"><meta data-rh="true" property="og:description" content="Service API"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-01-28T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/liviozanol"><meta data-rh="true" property="article:tag" content="automation,awx,ansible,gitlab,network automation,gitlab-ci,CI/CD,gitops,fastapi"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://livio.zanol.com.br/full-stack-it-automation-part-9-demo-api"><link data-rh="true" rel="alternate" href="https://livio.zanol.com.br/full-stack-it-automation-part-9-demo-api" hreflang="en"><link data-rh="true" rel="alternate" href="https://livio.zanol.com.br/full-stack-it-automation-part-9-demo-api" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bd4424da.css">
<link rel="preload" href="/assets/js/runtime~main.fd840988.js" as="script">
<link rel="preload" href="/assets/js/main.75488faf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/lzp-small.svg" alt="Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="32" width="32"><img src="/img/lzp-small.svg" alt="Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="32" width="32"></div><b class="navbar__title text--truncate">Livio&#x27;s Dump</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">All Blog Posts</a><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="mailto:livio@zanol.com.br" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">E-mail: livio@zanol.com.br<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_TMXw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V4zb margin-bottom--md">All posts</div><ul class="sidebarItemList_uHd5 clean-list"><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/non-contiguous-netmasks">Non-contiguous Netmasks</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/vmware-vds-traffic-filter">Using vSphere Distributed Switch (VDS) for stateless &quot;traffic filtering&quot; (or ACL)</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-11">Full-Stack Automation Part 11 - Conclusions</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-10-demo-ui">Full-Stack Automation Part 10 - Demo - UI</a></li><li class="sidebarItem_spIe"><a aria-current="page" class="sidebarItemLink_eqrF sidebarItemLinkActive_XZSJ" href="/full-stack-it-automation-part-9-demo-api">Full-Stack Automation Part 9 - Demo - API</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-8-demo-gitlab-runner">Full-Stack Automation Part 8 - Demo - Runner</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-7-demo-awx">Full-Stack Automation Part 7 - Demo - AWX</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-6-demo-scenario">Full-Stack Automation Part 6 - Demo -Scenario</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-5-gitlabci">Full-Stack Automation Part 5 - Gitlab CI</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-4-awx">Full-Stack Automation Part 4 - AWX</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-3-Vault">Full-Stack Automation Part 3 - Vault</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-2-gitlab">Full-Stack Automation Part 2 - Gitlab</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-1">Full-Stack Automation Part 1 - Overview</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/first">First Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Full-Stack Automation Part 9 - Demo - API</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-01-28T00:00:00.000Z" itemprop="datePublished">January 28, 2022</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/liviozanol.png" alt="Lívio Zanol Puppim"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lívio Zanol Puppim</span></a></div><small class="avatar__subtitle" itemprop="description">Me</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="service-api">Service API<a class="hash-link" href="#service-api" title="Direct link to heading">​</a></h2><p>In this section we will build our service API. It&#x27;s responsible to <em>receive direct user request</em>, check permissions and if authorized, read and modify files on our gitlab repository.</p><p>We will use python as the API language, but as explained before, you could use any language you want that can be built to receive and process HTTP requests. To make things a little faster, will be used <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI framework</a>. We will try to keep things as simple as possible for the demo, and some funtions may have some minor issues, but on your journey to build a production API you should take more cautions and make things as secure as possible.</p><p>After building the API, users should be able to access it using user/pass and view or change information from their WAN site.</p><p>All files generated on this section (and on previous) are on full-stack automation github repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>), so you don&#x27;t need to create it yourself again.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Please, note that in this demo we will use Hashicorp Vault 2 itself to store and verify users authentication and authorization with simple Key/Value and this is not safe/recommended at all. We will create 3 KV secrets in it, each one containing the username, the password and the tenants that each user can access. API simply queries this data and check if passwords match and checks which tenant users belong. Also, queries to the API will use a Basic HTTP Authentication using provided user/pass and that is also not safe and should not be used on production.</p><p>On a production environment you <em>MUST</em> use other method of authentication/authorzation.</p><p>If you already have an auth system you should consider integrating your APIs with it. If its an <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">OIDC</a>/<a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">OAuth2</a> even better, you can use its own specification to authorize and get users tenant based on custom scopes and it also has it own mean of temporary token exchange to enhace security.</p><p>If you want to build your own Auth, you need to get this information elsewhere. I like <a href="https://www.youtube.com/watch?v=d4Y2DkKbxM0" target="_blank" rel="noopener noreferrer">this</a> simple tutorial using React/GO that even uses JWT to exchange messages to/from API. You could also use some free OIDC as <a href="https://www.ory.sh/hydra/" target="_blank" rel="noopener noreferrer">Ory</a> to build on premise auth system, and we could have done this on this demo, but would make our demo too big, more than it already is. Python FastAPI have nice features to easily integrate with oAuth/OIDC.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Please note that I&#x27;m not a developer. You shouldn&#x27;t trust my code blindly (in fact, any code). But feel free to use it, change it and send me angry feedbacks and comments.</p></div></div><p>API source code for our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/api" target="_blank" rel="noopener noreferrer">here</a></p><p>Bastion configuration for our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/bastion" target="_blank" rel="noopener noreferrer">here</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="api-structure">API structure<a class="hash-link" href="#api-structure" title="Direct link to heading">​</a></h2><p>When you build APIs you almost always want to think your serevice on a <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD</a> way:</p><ul><li>How do you Create a service instance;</li><li>How do you Read/List your serivce instances;</li><li>How do you Update a service instance;</li><li>How do you Delete a service instance.</li></ul><p>Remebering our <a href="/full-stack-it-automation-part-6-demo-scenario">service definition</a>, our service is a WAN site LAN customization that users can change LAN IP addresses, set helper address, ACLs and some other infos. Thinking in a CRUD way would be something like this:</p><ul><li>Create/Enable a WAN site LAN interface (or install/activate/comission whole WAN site CPE, including its PE interface).</li><li>Read/List WAN sites LAN configuration.</li><li>Update/Change WAN sites LAN configuration.</li><li>Delete/Disable a WAN site LAN interface (or desinstall/descomission whole WAN site CPE).</li></ul><p>As you can see, Creating/Deleting our service could/should be a staff/operator activity, and we will not cover it on the demo, but if you want, you sure can! You would need to create playbooks involved on these tasks, change your gitlab runner to indetify when to execute each playbook (eg.: by a commit message?), create a way to authenticate/authorize your operators (could even use our Vault user/pass/tenant sctructure - just for a demo, please) and create these functions on the API/UI.</p><p>Considering the info above, we will build a <a href="https://restfulapi.net/" target="_blank" rel="noopener noreferrer">REST API</a> that receives either a HTTP GET(read/list) or PUT(update) request. The API will be stateless and you can scale it horizontally.</p><p>We will also use a bastion container using <a href="https://www.nginx.com/" target="_blank" rel="noopener noreferrer">NGINX</a> that receives our requests and identify to which API endpoint it should redirect it based on path (eg.: <a href="http://127.0.0.1/wan_site" target="_blank" rel="noopener noreferrer">http://127.0.0.1/wan_site</a> should go to our demo API). Keep in mind that each API container is responsible for its own auth function, our bastion hosts only pass our requests to the API based on the URL path (eg.: wan_site to wan_site APIs).</p><p>You could also add some cache layer if you want using something like <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">redis</a> if you have some complex automation. </p><p>Everything will be auto deployed by our gitlab runner using a CI/CD pipeline.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You could, and it is a good practice, create 2 separated APIs layers for any specific service deployed. The first one deals with data validation, business rules and other things related with user relationship and frontend. This is the API accessed by users and the web interface. Another one would be responsible with basic validation, parsing, uploading data on gitlab and other things related with automation itself. The first one only talks to the second one and never touches any piece of your automation infrastructure. You could also add an auth for this API to API conversation using JWT for example to secure it better.</p></div></div><p>The following picture demonstrate our expanded API layer for the demo (we will build a bastion host container and only one wan_site API container, but could be easilly scalable):
<img loading="lazy" alt="API layer architecture" src="/assets/images/api_arch-2bf5d3a520f0324630d2c7f2851ad246.svg" width="457" height="332" class="img_E7b_"></p><p>Demo with API running
<img loading="lazy" alt="API" src="/assets/images/api-d1e47fa284844fad2bff304f33bb000e.gif" width="605" height="338" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="bastion-nginx-configuration">Bastion NGINX configuration<a class="hash-link" href="#bastion-nginx-configuration" title="Direct link to heading">​</a></h2><p>We will keep bastion host configuration as simple as possible, and you should enhance its configuration if needed and can read more about NGINX configuration <a href="https://docs.nginx.com/nginx/admin-guide" target="_blank" rel="noopener noreferrer">here</a>.</p><p>We will use <a href="https://hub.docker.com/_/nginx" target="_blank" rel="noopener noreferrer">official alpine nginx docker image</a> and create 3 files:</p><ul><li><code>apis.conf</code> that will have our proxy_pass redirecting requests containing wan_sites on path to our API. For every API you create, just add a line like this, redirecting to the correct API endpoint. 127.0.0.1 will be replaced by our script with the real IP from our host.</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">location /wan_sites </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    proxy_pass http://127.0.0.1:10042/wan_sites</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include /etc/nginx/conf.d/APIs/default_proxy.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>default_proxy.conf</code> that will have our common proxy configuration for every API:</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_http_version  </span><span class="token number">1.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_cache_bypass  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$http_upgrade</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header Host               </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Real-IP          </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$remote_addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-For    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$proxy_add_x_forwarded_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Proto  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Host   </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Port   </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$server_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_connect_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_send_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_read_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>default.conf</code> that is basically own nginx default.conf just adding include clause to import our <code>apis.conf</code>:</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen       </span><span class="token number">80</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">::</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">:80</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    server_name  localhost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include /etc/nginx/conf.d/APIs/*.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="api-code-and-server">API code and server<a class="hash-link" href="#api-code-and-server" title="Direct link to heading">​</a></h2><p>As stated on the beginning we will use <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI framework</a> to build our API. We will publish it using <a href="https://www.uvicorn.org/" target="_blank" rel="noopener noreferrer">Uvicorn</a> on a container.</p><p>You could scale it simply creating more containers and changing nginx bastion host config (if not on kubernetes) to load balance between them (please use <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check" target="_blank" rel="noopener noreferrer">healthchecks</a>), or use some more structured approaches using <a href="https://fastapi.tiangolo.com/deployment/server-workers" target="_blank" rel="noopener noreferrer">gunicorn</a> or even more complex structures with cache layers.</p><p>The created code is simple and structured in a approach more close to Functional Programming rather than Object Oriented (OOP). It has 3 files:</p><ul><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/main.py" target="_blank" rel="noopener noreferrer">main.py</a></li><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/check_permissions.py" target="_blank" rel="noopener noreferrer">check_permissions.py</a></li><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/wan_api_functions.py" target="_blank" rel="noopener noreferrer">wan_api_functions.py</a></li></ul><p>main.py is responsible to handle the HTTP requests, check if user have permissions, and send the requests to the appropriate functions that processes them. If a user send a GET request to the path &quot;/wan_sites&quot; main.py, after checking permissions, will send the request to the function that get sites JSON data from gitlab and return them.</p><p>check_permissions.py is responsible to get credentials from the HTTP Authorization header, check if they match the stored one on vault and get the tenants that user has permission. For EVERY request the Auth Header <em>must</em> be sent to the API and requests are only processed if they are authorized on vault. Separating the permission check in functions like this, allow us to easially change how this check is done to use other auth providers like OIDC. The function can do whatever you want, just needing to return what tenants does that user has permission.</p><p>wan_api_functions.py is our principal file and is the one that we work the most coding. It contains all functions related to the API objective itself. It has functions to get data from gitlab, to list pipeline jobs and its status, to receive UPDATE requests from user and validate it and so on. The biggest and most workly function here is the one that validate the user data on a UPDATE requests. It has a lot of strictly validating rules based on our data definition and is the function that you need to have most care and takes more time to build.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>We have created a new HTTP GET path on our API that will list the last x pipeline jobs and its status. This can be used by the user to check if its UPDATE is finished or not and will also be used on the web UI.</p><p>On the UPDATE API path we have configured the function to accept a query string that will make the UPDATE syncronous (wait until the job pipeline is finished) or asyncronous (just UPDATE gitlab file with user data).</p><p>We have made a separate validation function for user data because we wanted to make some complex data validation besides simple string/int/boolean/regex one. FastAPI has some good options for simple data validation using strong integration with <a href="https://pydantic-docs.helpmanual.io/" target="_blank" rel="noopener noreferrer">pydantic</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-bastion-host-and-api-using-gitlab-runner">Deploying Bastion host and API using gitlab runner<a class="hash-link" href="#deploying-bastion-host-and-api-using-gitlab-runner" title="Direct link to heading">​</a></h2><p>As stated before, we will use the same gitlab runner that call AWX to automatic deploy our API and bastion/reverse proxy. On a production environment, the API/bastion gitlab runner should be separated.</p><p>Will be created 2 repositories on gitlab: 1 for our bastion host and another for our API. Gitlab runner will watch these repos and update our API or bastion container everytime we modify it.</p><p>Again, <a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/.gitlab-ci.yml" target="_blank" rel="noopener noreferrer">our CI/CD pipeline</a> will be VERY simple, without even testing our application before deploy. Please note that adding more stages with some good tests, validation, approval is very recommended for the APIs and also for UI. For simplicity, also the bastion/API update process will be disruptive (stop old caontainers and running new ones), but you can easilly achieve high availability for the APIs scaling them horizontally and Load Balancing with healthchecks on bastion hosts. Updating the bastion/reverse proxy container  without disrupting it thougha is more difficult.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="testing-the-api-witch-curl">Testing the API witch CURL<a class="hash-link" href="#testing-the-api-witch-curl" title="Direct link to heading">​</a></h2><p>When the API is deployed you can test its functions using curl like below:</p><ul><li><p>Listing Client A WAN sites
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites | jq</code></p></li><li><p>Getting one specific site from Client B:
<code>curl --user client_b_user:client_b_user 127.0.0.1:10042/wan_sites/site_3 | jq</code></p></li><li><p>Updating info for site 1 from Client A asyncronous (please, create CHANGED_FILE.json with your changes):
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites/site_1?sync=0 -X PUT --data @demo/api/update_test_files/CHANGED_FILE.json</code></p></li><li><p>List the last 10 jobs for site 1:
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites/site_1/jobs?number_of_jobs=10 | jq</code></p></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/automation">automation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/awx">awx</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ansible">ansible</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlab">gitlab</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/network-automation">network automation</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitlab-ci">gitlab-ci</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/ci-cd">CI/CD</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/gitops">gitops</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/fastapi">fastapi</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/liviozanol/liviozanol.github.io/blog/2022-01-28-automation-9/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/full-stack-it-automation-part-10-demo-ui"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Full-Stack Automation Part 10 - Demo - UI</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/full-stack-it-automation-part-8-demo-gitlab-runner"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Full-Stack Automation Part 8 - Demo - Runner</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#service-api" class="table-of-contents__link toc-highlight">Service API</a></li><li><a href="#api-structure" class="table-of-contents__link toc-highlight">API structure</a></li><li><a href="#bastion-nginx-configuration" class="table-of-contents__link toc-highlight">Bastion NGINX configuration</a></li><li><a href="#api-code-and-server" class="table-of-contents__link toc-highlight">API code and server</a></li><li><a href="#deploying-bastion-host-and-api-using-gitlab-runner" class="table-of-contents__link toc-highlight">Deploying Bastion host and API using gitlab runner</a></li><li><a href="#testing-the-api-witch-curl" class="table-of-contents__link toc-highlight">Testing the API witch CURL</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Livio Zanol Puppim (livio@zanol.com.br). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fd840988.js"></script>
<script src="/assets/js/main.75488faf.js"></script>
</body>
</html>