<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Livio&#39;s Dump RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Livio&#39;s Dump Atom Feed"><title data-rh="true">Using vSphere Distributed Switch (VDS) for stateless &quot;traffic filtering&quot; (or ACL) | Livio&#x27;s Dump</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://livio.zanol.com.br/vmware-vds-traffic-filter"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Using vSphere Distributed Switch (VDS) for stateless &quot;traffic filtering&quot; (or ACL) | Livio&#x27;s Dump"><meta data-rh="true" name="description" content="Intro"><meta data-rh="true" property="og:description" content="Intro"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2022-04-07T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/liviozanol"><meta data-rh="true" property="article:tag" content="vmware vds,nsx-t,cloud infrastructure,security,acl,traffic filter"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://livio.zanol.com.br/vmware-vds-traffic-filter"><link data-rh="true" rel="alternate" href="https://livio.zanol.com.br/vmware-vds-traffic-filter" hreflang="en"><link data-rh="true" rel="alternate" href="https://livio.zanol.com.br/vmware-vds-traffic-filter" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.bd4424da.css">
<link rel="preload" href="/assets/js/runtime~main.fd840988.js" as="script">
<link rel="preload" href="/assets/js/main.75488faf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/lzp-small.svg" alt="Logo" class="themedImage_W2Cr themedImage--light_TfLj" height="32" width="32"><img src="/img/lzp-small.svg" alt="Logo" class="themedImage_W2Cr themedImage--dark_oUvU" height="32" width="32"></div><b class="navbar__title text--truncate">Livio&#x27;s Dump</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">All Blog Posts</a><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></div><div class="navbar__items navbar__items--right"><a href="mailto:livio@zanol.com.br" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">E-mail: livio@zanol.com.br<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_TMXw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V4zb margin-bottom--md">All posts</div><ul class="sidebarItemList_uHd5 clean-list"><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/non-contiguous-netmasks">Non-contiguous Netmasks</a></li><li class="sidebarItem_spIe"><a aria-current="page" class="sidebarItemLink_eqrF sidebarItemLinkActive_XZSJ" href="/vmware-vds-traffic-filter">Using vSphere Distributed Switch (VDS) for stateless &quot;traffic filtering&quot; (or ACL)</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-11">Full-Stack Automation Part 11 - Conclusions</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-10-demo-ui">Full-Stack Automation Part 10 - Demo - UI</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-9-demo-api">Full-Stack Automation Part 9 - Demo - API</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-8-demo-gitlab-runner">Full-Stack Automation Part 8 - Demo - Runner</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-7-demo-awx">Full-Stack Automation Part 7 - Demo - AWX</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-6-demo-scenario">Full-Stack Automation Part 6 - Demo -Scenario</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-5-gitlabci">Full-Stack Automation Part 5 - Gitlab CI</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-4-awx">Full-Stack Automation Part 4 - AWX</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-3-Vault">Full-Stack Automation Part 3 - Vault</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-2-gitlab">Full-Stack Automation Part 2 - Gitlab</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/full-stack-it-automation-part-1">Full-Stack Automation Part 1 - Overview</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/first">First Post</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Using vSphere Distributed Switch (VDS) for stateless &quot;traffic filtering&quot; (or ACL)</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-07T00:00:00.000Z" itemprop="datePublished">April 7, 2022</time> · <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/liviozanol.png" alt="Lívio Zanol Puppim"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/liviozanol" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Lívio Zanol Puppim</span></a></div><small class="avatar__subtitle" itemprop="description">Me</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_mojV" id="intro">Intro<a class="hash-link" href="#intro" title="Direct link to heading">​</a></h2><p>VMWare has a nice product called <a href="https://www.vmware.com/br/products/nsx.html" target="_blank" rel="noopener noreferrer">NSX-T</a> which allows you to build a sort of a cloud provider network infrastructure for your virtualized environment  (and K8s). It has network segmentation, routing, NAT, stateful firewall, IDS, traffic inspection, etc.</p><p>What if you already have a good and working cloud-like architecture and just want to insert some simple ACLs directly on the virtualization layer to outsource traffic filtering directly to the hypervisor, and do not want fancy things like firewall, NAT, IDS, etc. ?</p><p>vSwitch doesn&#x27;t support this; NSX-T does, but it is expensive... What about VDS???</p><p>Python scripts used available at git repository: <a href="https://github.com/liviozanol/vmware_vds_traffic_filter" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/vmware_vds_traffic_filter</a></p><p>Well, using vCenter web UI (you can use this <a href="https://www.vmwarelearningplatform.com/HOL/console/lab/HOL-2211-01-SDC-HOL" target="_blank" rel="noopener noreferrer">Hands-on Lab</a> to check), if you navigate to the VDS itself, and select a portgroup and click configure, you will see that it has some sort of Traffic Filtering. So, despite this almost hidden function (poor UI design in my opinion) it CAN filter traffic.</p><p><img loading="lazy" alt="Port Group on vSphere" src="/assets/images/portgroup-a00ab32c28d5036f139ad36d7b5e3d66.png" width="1228" height="445" class="img_E7b_"></p><p>If you snoop the web interface a little bit you will  see that this looks like a normal network equipment ACL using the classic 5 tuples (src IP, dst IP, L4 protocol, src port, dst port) and input/output direction to apply the filter.</p><p><img loading="lazy" alt="Creating rules on web UI" src="/assets/images/create_rule-9ed69b4134d1b0a576ad01a849217cc3.png" width="809" height="629" class="img_E7b_"></p><p>Ok... So, it may be possible to apply filters, but this UI is not helpful at all to create and manage a bunch of ACLs (nor to give end-users permission to apply it). Lets try with the API.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vsphere-api">vSphere API<a class="hash-link" href="#vsphere-api" title="Direct link to heading">​</a></h2><p>vCenter has a &quot;new&quot; REST API, launched since version 6.5. But if you look at their <a href="https://developer.vmware.com/apis/vsphere-automation/latest/vcenter" target="_blank" rel="noopener noreferrer">documentation</a> you will see that it is <strong>very</strong> limited and still needs to be involved to be useful for automation. Hey VMWARE, come on, prioritize vSphere REST API on your product backlog... Oh wait! Maybe you don&#x27;t want to for some reason?</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p><em>As a side note, NSX-T has a pretty complete, good structured and <a href="https://developer.vmware.com/apis/976" target="_blank" rel="noopener noreferrer">well documented REST API</a></em></p></div></div><p>But vSphere also has another &quot;Web Service API&quot; that can be accessed <a href="https://developer.vmware.com/apis/1192/vsphere" target="_blank" rel="noopener noreferrer">here</a>. It is very complete and you will be able to do almost anything with it, and in fact, it is used by ansible VMWare modules. The documentation is not as good as NSX-T and it is not REST, but it is something.</p><p>If you search for &quot;DvsTraffic&quot; on Data Object Types, you will find some interesting things. Let&#x27;s check <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.DistributedVirtualPort.TrafficFilterConfig.html" target="_blank" rel="noopener noreferrer"><code>DVSTrafficFilterConfig</code></a>: </p><ul><li>You will see that it supports one property called <code>DvsTrafficRuleset</code>;</li><li>Digging in <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRuleset.html" target="_blank" rel="noopener noreferrer">DvsTrafficRuleset</a>, it supports <code>enabled</code>, some other properties and <code>DvsTrafficRule</code> object. Let&#x27;s go deeper;</li><li><a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRule.html" target="_blank" rel="noopener noreferrer">DvsTrafficRule</a> supports <code>action</code> which could be used to permit or deny traffic on match (besides other actions). Also supports <code>sequence</code>, <code>direction</code> and <code>qualifier</code> fields. As stated on the page about qualifier:
    - List of Network rule qualifiers. &#x27;AND&#x27; of this array of network rule qualifiers is applied as one network traffic rule. If the TrafficRule belongs to DvsFilterPolicy : There can be a maximum of 1 <code>DvsIpNetworkRuleQualifier</code>, 1 DvsMacNetworkRuleQualifier and 1 DvsSystemTrafficNetworkRuleQualifier for a total of 3 qualifier.
    - Let&#x27;s check <code>DvsIpNetworkRuleQualifier</code> than...</li><li>Hey! <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRule.IpQualifier.html" target="_blank" rel="noopener noreferrer">DvsIpNetworkRuleQualifier</a> supports the 5 tuples!
    - Look! It supports <code>tcpFlags</code> also! Maybe we could simulate an &#x27;established&#x27; ACL keyword, creating an ACL which matches only segments with ACK and/or RST!
    - Oh no... Look at the description... &quot;<em>TCP flags are not supported by Traffic Filtering</em>&quot;. Ok, but we can still create traffic rules...</li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>This TCP Flags thing really got me the first time I tried to use DVS filter because this text was only added on documentation for version 7.0... So I tried to use this on the 6.5 version without success but could never figure out the reason that it wasn&#x27;t working... <a href="https://developer.vmware.com/apis/358/vsphere/doc/vim.dvs.TrafficRule.IpQualifier.html" target="_blank" rel="noopener noreferrer">Check the old version without this text</a>.</p></div></div><p>So, to effectively apply ACLs on DVS you need to:</p><ul><li>Define the 5 rule tuples using <code>DvsIpNetworkRuleQualifier</code>.</li><li>Append it to a <code>qualifier</code> on a <code>DvsTrafficRule</code>.</li><li>Set <code>DvsTrafficRule</code> <code>description</code>, <code>direction</code> and <code>action</code>.</li><li>Append this <code>DvsTrafficRule</code> to a <code>DvsTrafficRuleset</code>.</li><li>Set <code>DVSTrafficFilterConfig</code> with the <code>DvsTrafficRuleset</code> you just created.</li><li>Apply <code>DVSTrafficFilterConfig</code> to a port group.</li><li>Enable traffic filtering on that port group.</li></ul><p>Some questions about this VDS traffic filter rise:</p><ul><li>How many rules can I create?
    - Well, there isn&#x27;t any documentation about this limit and VMWare <strong>must</strong> provide support to your vSphere even if you apply a long list of rules. Well, at least in theory, but I doubt that if you apply 10.000+ rules on your production environment VMWare will be able to help you...</li><li>Is it stable? How is latency (ms overhead) and throughput (less pps) impacted by rules? What about the bare metal CPU usage (could increase since it&#x27;s processing traffic to match rules)?
    - Really don&#x27;t know... You could build some test scenarios to validate.</li><li>Where/When the rules are processed.
    - Don&#x27;t know... Maybe it is like the DFW rules from NSX-T and they are processed on kernel hooks giving a good performance... But haven&#x27;t looked for it.</li><li>Can I apply ACLs for an specific VM? Can I apply to uplinks?
    - YES! You can!</li></ul><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>Be careful when using API to manipulate trafficRules like this. There are some functionalities that are only available through API! If you create some certain kind of rules using API you may be not able to see it on WEB UI! Worst: No errors are shown, but the rules are still there! If you want to delete or edit them, you&#x27;ll need to do it using the API itself.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="python-scripts">Python Scripts<a class="hash-link" href="#python-scripts" title="Direct link to heading">​</a></h2><p>The vSphere API described before is commonly used through an SDK previously built by vmware itself. A lot of people use PowerShell SDK (called <a href="https://developer.vmware.com/web/tool/12.5.0/vmware-powercli" target="_blank" rel="noopener noreferrer">PowerCLI</a>). I like the python SDK called <a href="https://github.com/vmware/pyvmomi" target="_blank" rel="noopener noreferrer">pyvimovi</a> which is also used by ansible modules.</p><p>I&#x27;ve uploaded 2 scripts to github. The first one lists rules on DVS and the second creates rules on DVS. Could have been only one, but that&#x27;s ok...</p><p><a href="https://github.com/liviozanol/vmware_vds_traffic_filter/blob/main/list_vds_portgroup_rules.py" target="_blank" rel="noopener noreferrer"><code>list_vds_portgroup_rules.py</code></a> list rules for a specific portgroup. You pass dvswitch name, portgroup name and rule_id (optional) as argument to the script and all rules for that portgroup is outputted on a JSON formatted string.</p><p><a href="https://github.com/liviozanol/vmware_vds_traffic_filter/blob/main/edit_vds_portgroup_rules.py" target="_blank" rel="noopener noreferrer"><code>edit_vds_portgroup_rules.py</code></a> edit, create and delete rules for a specific portgroup using a JSON file as source. The JSON file needs to have a specific format. In the following example we intended to create a simple TCP rule on port 53 to google DNS. Keep in mind that <a href="https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml" target="_blank" rel="noopener noreferrer">protocol number must follow IANA definition</a>: (this example is also on script help):</p><div class="language-JSON codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-JSON codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sourceAddress&quot;:&quot;any&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;destinationAddress&quot;:&quot;8.8.8.8/32&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;sourcePort&quot;:&quot;1024-60000&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;destinationPort&quot;:&quot;53&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;protocol&quot;:&quot;6&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;action&quot;:&quot;accept&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;direction&quot;:&quot;both&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;description&quot;:&quot;DNS google&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>vSphere Distributed Switch (VDS), along with other features like QoS, mark, shaping, LACP, etc. also supports stateless traffic filtering using 5 tuples.</p><p>Since I never tested it on production, I can&#x27;t recommend you to do so. If you have some case scenarios for this or have already tested this on a production environment, please, feel free to send some data or feedback so I can share with others.</p><p>You could use these scripts to automate VDS using ansible directly (just install pyvimomi) calling it as a &quot;shell&quot; command. Or, you could use it to create an ansible module.</p><p>Any feedback is appreciated.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/vmware-vds">vmware vds</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/nsx-t">nsx-t</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/cloud-infrastructure">cloud infrastructure</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/security">security</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/acl">acl</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/tags/traffic-filter">traffic filter</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/liviozanol/liviozanol.github.io/blog/2022-04-07-vmware-vds-traffic-filter/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/non-contiguous-netmasks"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Non-contiguous Netmasks</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/full-stack-it-automation-part-11"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Full-Stack Automation Part 11 - Conclusions</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#intro" class="table-of-contents__link toc-highlight">Intro</a></li><li><a href="#vsphere-api" class="table-of-contents__link toc-highlight">vSphere API</a></li><li><a href="#python-scripts" class="table-of-contents__link toc-highlight">Python Scripts</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Livio Zanol Puppim (livio@zanol.com.br). Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fd840988.js"></script>
<script src="/assets/js/main.75488faf.js"></script>
</body>
</html>