<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://livio.zanol.com.br/</id>
    <title>Livio's Dump Blog</title>
    <updated>2022-05-20T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://livio.zanol.com.br/"/>
    <subtitle>Livio's Dump Blog</subtitle>
    <icon>https://livio.zanol.com.br/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[Non-contiguous Netmasks]]></title>
        <id>non-contiguous-netmasks</id>
        <link href="https://livio.zanol.com.br/non-contiguous-netmasks"/>
        <updated>2022-05-20T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Intro]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="intro">Intro<a class="hash-link" href="#intro" title="Direct link to heading">​</a></h2><p>A long time ago (2006), When I was still graduating in computer science, I’ve made a <a href="https://www.youtube.com/watch?v=QsUlySdtqaw" target="_blank" rel="noopener noreferrer">video</a> showing the communication between 2 openBSD VMs configured with non-contiguous network masks (eg: 255.255.0.255 or 255.255.255.1) talking to each other.</p><p>At that time, I tried to use non-contiguous masks on Windows, Linux (Gentoo?), FreeBSD and OpenBSD. Only OpenBSD was able to make this kind of configuration.</p><p>Maybe having subnets with non-continuous masks aren't useful at all, but what about firewalls/filters? Having this possibility can be good and suppress some (many?) lines of rules depending on your scenario.</p><p>The below video demonstrates a working environment using non-contiguous netmask on OpenBSD and also a working routing scenario between 2 subnets (one with EVEN IPs and one with ODDs IPs):</p><iframe width="600" height="400" src="https://www.youtube.com/embed/QsUlySdtqaw"></iframe><p>I've made this video after a conversation with some coleagues about general network fundamentals. At that time I was trying to figure out how to scan networks like this using NMAP and started a discussion at the mailing list (<a href="http://seclists.org/nmap-dev/2006/q4/50" target="_blank" rel="noopener noreferrer">http://seclists.org/nmap-dev/2006/q4/50</a>). Fortunately, nmap gives us some good options for this using wildcards. You can start a nmap scan with a range like <code>192.168.0-100.1</code> or <code>192.168.*.1</code> or even <code>192.168.0.1,3,5,7,9</code>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-fundamentals">The fundamentals<a class="hash-link" href="#the-fundamentals" title="Direct link to heading">​</a></h2><p>Network calculations are based on <a href="https://en.wikipedia.org/wiki/Bitwise_operation" target="_blank" rel="noopener noreferrer">bitwise operations</a>, and so are IP/mask 5-tuples filters/rules. If you want to know if an IP address belongs to an IP/subnet you can do an "AND" binary comparison using this IP and the subnet and compare the result with the intended IP and the same subnet. If the results are equal, they belong to the same subnet. (eg.: 192.168.0.1 AND 255.255.255.0 = 192.168.0.0, so is 192.168.0.250 AND 255.255.255.0). If you want to read a more complete calculation explanation you can <a href="https://www.prado.it/2016/05/21/.yet-another-post-about-ipv4-subnetting-non-contiguous-bits-version/" target="_blank" rel="noopener noreferrer">read this post</a></p><p>Since everything is bit afterall, why couldn't we use non-contiguous netmasks? I don't know exactly the reason. <a href="https://datatracker.ietf.org/doc/html/rfc950" target="_blank" rel="noopener noreferrer">RFC 950</a> doesn't specify it as mandatory and also includes an explanation on its appendix with a non-contiguous example, but this old RFC was already "overwritten" by new ones that clearly stated that netmask bit <strong>must</strong> b contiguous. Maybe they wanted network configuration to be easier to understand?</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="checking-non-contiguous-subnet-mask-configuration-today">Checking non-contiguous Subnet Mask configuration Today<a class="hash-link" href="#checking-non-contiguous-subnet-mask-configuration-today" title="Direct link to heading">​</a></h2><p>I have made new tests on this subject, trying to configure an IP address with netmask 255.255.0.255 on some interface and the results are:</p><ul><li>FreeBSD 13.1: <strong>Supported</strong>! Didn't work in 2006.</li><li>MAC OS: Didn't test.</li><li>OpenBSD 7.1: <strong>Supported</strong>.</li><li>Ubuntu 22.04: Not supported. (either using iproute2 or ifconfig)</li><li>Windows 10: Not supported.</li></ul><p>I have tried to figure out why iproute2 on Ubuntu didn't allow me to make this configuration by investigating the source code. I don't know much about C and coded very little in it, so I find it difficult to understand some of the iproute2 code (and kernel too). Well, using the error message displayed <code>Error: any valid prefix is expected rather than "192.168.0.1/255.255.0.255"</code>, I was able to identify that this error is returned by function <a href="https://git.kernel.org/pub/scm/network/iproute2/iproute2.git/tree/lib/utils.c#n651" target="_blank" rel="noopener noreferrer">get_prefix_1</a>, more specific, inside get_prefix_1, it detected the error with the function <a href="https://git.kernel.org/pub/scm/network/iproute2/iproute2.git/tree/lib/utils.c#n164" target="_blank" rel="noopener noreferrer">get_netmask</a>. Reading the code below, I can suggest (but can't be sure) that it tries to convert our dotted decimal mask to a CIDR and then returns an error.</p><div class="language-C codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-C codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF codeBlockLinesWithNumbering_hGCP"><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">static int get_netmask(unsigned int *val, const char *arg, int base)</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">{</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    inet_prefix addr;</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain" style="display:inline-block"></span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    if (!get_unsigned(val, arg, base))</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">        return 0;</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain" style="display:inline-block"></span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    /* try converting dotted quad to CIDR */</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    if (!get_addr_1(&amp;addr, arg, AF_INET) &amp;&amp; addr.family == AF_INET) {</span></span></span><span class="token-line theme-code-block-highlighted-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">        int b = mask2bits(addr.data[0]);</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain" style="display:inline-block"></span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">        if (b &gt;= 0) {</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">            *val = b;</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">            return 0;</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">        }</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    }</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain" style="display:inline-block"></span></span></span><span class="token-line theme-code-block-highlighted-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">    return -1;</span></span></span><span class="token-line codeLine_rqGN" style="color:#F8F8F2"><span class="codeLineNumber_hzTh"></span><span class="codeLineContent_hM6e"><span class="token plain">}</span></span></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="packet-filters-and-firewalls">Packet filters and firewalls<a class="hash-link" href="#packet-filters-and-firewalls" title="Direct link to heading">​</a></h2><p>Ok, on FreeBSD and OpenBSD we can configure non-contiguous masks, but It isn't very useful nowadays. But what about using it to filter packets on firewalls and ACLs? Well, in some scenarios it could be useful.</p><p>Imagine for example, you have a lot of remote WAN sites concentrating traffic on a central office on a typical hub-and-spoke topology and you have a well defined remote ip addressing police and every WAN site has a /24 subnet and a specific equipment (pbx/printer/proxy/router/whatever) is always the last IP. What if you want to allow traffic only from this IP from all sites on your central office, but block any other? In this case, on a typical implementation, you would have to create 1 /32 rule for each remote site.</p><p>Ex.:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">permit ip 10.0.1.254/32 any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">permit ip 10.0.2.254/32 any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">permit ip 10.0.3.254/32 any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deny any any (implied)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you could use non-contiguous netmask you could solve this problem with only one line, like:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">permit ip 10.0.0.254/255.255.0.255 any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deny any any (implied)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or using wildcard:</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">permit ip 10.0.0.254 0.0.255.0 any</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">deny any any (implied)</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Do routers support this? What about firewalls? Tested some of them. These are the results (won't put specific OS versions):</p><ul><li>IOS: Supported.</li><li>IOS XE: Supported.</li><li>IOS XR: Supported.</li><li>NX OS: Supported.</li><li>Huawei VRP: Supported.</li><li>Windows O.S. Firewall: <strong>Not Supported</strong>.</li><li>IPtables: Supported.</li><li>PF: Didn't test. <a href="https://man.openbsd.org/pf.conf" target="_blank" rel="noopener noreferrer">Documentation</a> specify CIDR notation or ranges.</li></ul><p>Nice! Almost every equipment/firewall supports it! So yes, you can use this to make a more intelligent filter, just don't forget that other people may be reading and managing the equipment/software with you, they must be notified about it, since reading this kind of configuration for the first time can be confusing.</p><p>Also, as a side note, since IPtables support this kind of rule, and docker and kubernetes relies on it, I think you could mock a sort of non-contiguous netmask configuration on it. But please, don't.</p><p>Another point to note is that <a href="https://github.com/xdp-project/xdp-tutorial" target="_blank" rel="noopener noreferrer">eBPF XDP</a> has been rising as a solution for simple filters and firewalls. Being <em>very</em> basic on the definition, XDP lets you execute a user-built program for every packet that arrives on an interface so you can decide whatever you want to do with it. So for sure it can support non-contiguous masks. Maybe in the future, I can write more about XDP.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="network fundamentals" term="network fundamentals"/>
        <category label="subnet" term="subnet"/>
        <category label="iptables" term="iptables"/>
        <category label="acl" term="acl"/>
        <category label="routing" term="routing"/>
        <category label="pf" term="pf"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Using vSphere Distributed Switch (VDS) for stateless "traffic filtering" (or ACL)]]></title>
        <id>vmware-vds-traffic-filter</id>
        <link href="https://livio.zanol.com.br/vmware-vds-traffic-filter"/>
        <updated>2022-04-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Intro]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="intro">Intro<a class="hash-link" href="#intro" title="Direct link to heading">​</a></h2><p>VMWare has a nice product called <a href="https://www.vmware.com/br/products/nsx.html" target="_blank" rel="noopener noreferrer">NSX-T</a> which allows you to build a sort of a cloud provider network infrastructure for your virtualized environment &nbsp;(and K8s). It has network segmentation, routing, NAT, stateful firewall, IDS, traffic inspection, etc.</p><p>What if you already have a good and working cloud-like architecture and just want to insert some simple ACLs directly on the virtualization layer to outsource traffic filtering directly to the hypervisor, and do not want fancy things like firewall, NAT, IDS, etc. ?</p><p>vSwitch doesn't support this; NSX-T does, but it is expensive... What about VDS???</p><p>Python scripts used available at git repository: <a href="https://github.com/liviozanol/vmware_vds_traffic_filter" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/vmware_vds_traffic_filter</a></p><p>Well, using vCenter web UI (you can use this <a href="https://www.vmwarelearningplatform.com/HOL/console/lab/HOL-2211-01-SDC-HOL" target="_blank" rel="noopener noreferrer">Hands-on Lab</a> to check), if you navigate to the VDS itself, and select a portgroup and click configure, you will see that it has some sort of Traffic Filtering. So, despite this almost hidden function (poor UI design in my opinion) it CAN filter traffic.</p><p><img loading="lazy" alt="Port Group on vSphere" src="/assets/images/portgroup-a00ab32c28d5036f139ad36d7b5e3d66.png" width="1228" height="445" class="img_E7b_"></p><p>If you snoop the web interface a little bit you will &nbsp;see that this looks like a normal network equipment ACL using the classic 5 tuples (src IP, dst IP, L4 protocol, src port, dst port) and input/output direction to apply the filter.</p><p><img loading="lazy" alt="Creating rules on web UI" src="/assets/images/create_rule-9ed69b4134d1b0a576ad01a849217cc3.png" width="809" height="629" class="img_E7b_"></p><p>Ok... So, it may be possible to apply filters, but this UI is not helpful at all to create and manage a bunch of ACLs (nor to give end-users permission to apply it). Lets try with the API.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vsphere-api">vSphere API<a class="hash-link" href="#vsphere-api" title="Direct link to heading">​</a></h2><p>vCenter has a "new" REST API, launched since version 6.5. But if you look at their <a href="https://developer.vmware.com/apis/vsphere-automation/latest/vcenter" target="_blank" rel="noopener noreferrer">documentation</a> you will see that it is <strong>very</strong> limited and still needs to be involved to be useful for automation. Hey VMWARE, come on, prioritize vSphere REST API on your product backlog... Oh wait! Maybe you don't want to for some reason?</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p><em>As a side note, NSX-T has a pretty complete, good structured and <a href="https://developer.vmware.com/apis/976" target="_blank" rel="noopener noreferrer">well documented REST API</a></em></p></div></div><p>But vSphere also has another "Web Service API" that can be accessed <a href="https://developer.vmware.com/apis/1192/vsphere" target="_blank" rel="noopener noreferrer">here</a>. It is very complete and you will be able to do almost anything with it, and in fact, it is used by ansible VMWare modules. The documentation is not as good as NSX-T and it is not REST, but it is something.</p><p>If you search for "DvsTraffic" on Data Object Types, you will find some interesting things. Let's check <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.DistributedVirtualPort.TrafficFilterConfig.html" target="_blank" rel="noopener noreferrer"><code>DVSTrafficFilterConfig</code></a>: </p><ul><li>You will see that it supports one property called <code>DvsTrafficRuleset</code>;</li><li>Digging in <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRuleset.html" target="_blank" rel="noopener noreferrer">DvsTrafficRuleset</a>, it supports <code>enabled</code>, some other properties and <code>DvsTrafficRule</code> object. Let's go deeper;</li><li><a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRule.html" target="_blank" rel="noopener noreferrer">DvsTrafficRule</a> supports <code>action</code> which could be used to permit or deny traffic on match (besides other actions). Also supports <code>sequence</code>, <code>direction</code> and <code>qualifier</code> fields. As stated on the page about qualifier:
&nbsp; &nbsp; - List of Network rule qualifiers. 'AND' of this array of network rule qualifiers is applied as one network traffic rule. If the TrafficRule belongs to DvsFilterPolicy : There can be a maximum of 1 <code>DvsIpNetworkRuleQualifier</code>, 1 DvsMacNetworkRuleQualifier and 1 DvsSystemTrafficNetworkRuleQualifier for a total of 3 qualifier.
&nbsp; &nbsp; - Let's check <code>DvsIpNetworkRuleQualifier</code> than...</li><li>Hey! <a href="https://vdc-download.vmware.com/vmwb-repository/dcr-public/bf660c0a-f060-46e8-a94d-4b5e6ffc77ad/208bc706-e281-49b6-a0ce-b402ec19ef82/SDK/vsphere-ws/docs/ReferenceGuide/vim.dvs.TrafficRule.IpQualifier.html" target="_blank" rel="noopener noreferrer">DvsIpNetworkRuleQualifier</a> supports the 5 tuples!
&nbsp; &nbsp; - Look! It supports <code>tcpFlags</code> also! Maybe we could simulate an 'established' ACL keyword, creating an ACL which matches only segments with ACK and/or RST!
&nbsp; &nbsp; - Oh no... Look at the description... "<em>TCP flags are not supported by Traffic Filtering</em>". Ok, but we can still create traffic rules...</li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>This TCP Flags thing really got me the first time I tried to use&nbsp;DVS filter because this text was only added on documentation for version 7.0... So I tried to use this on the 6.5 version without success but could never figure out the reason that it wasn't working... <a href="https://developer.vmware.com/apis/358/vsphere/doc/vim.dvs.TrafficRule.IpQualifier.html" target="_blank" rel="noopener noreferrer">Check the old version without this text</a>.</p></div></div><p>So, to effectively apply ACLs on DVS you need to:</p><ul><li>Define the 5 rule tuples using <code>DvsIpNetworkRuleQualifier</code>.</li><li>Append it to a <code>qualifier</code> on a <code>DvsTrafficRule</code>.</li><li>Set <code>DvsTrafficRule</code> <code>description</code>, <code>direction</code> and <code>action</code>.</li><li>Append this <code>DvsTrafficRule</code> to a <code>DvsTrafficRuleset</code>.</li><li>Set <code>DVSTrafficFilterConfig</code> with the <code>DvsTrafficRuleset</code> you just created.</li><li>Apply <code>DVSTrafficFilterConfig</code> to a port group.</li><li>Enable traffic filtering on that port group.</li></ul><p>Some questions about this VDS traffic filter rise:</p><ul><li>How many rules can I create?
&nbsp; &nbsp; - Well, there isn't any documentation about this limit and VMWare <strong>must</strong> provide support to your vSphere even if you apply a long list of rules. Well, at least in theory, but I doubt that if you apply 10.000+ rules on your production environment VMWare will be able to help you...</li><li>Is it stable? How is latency (ms overhead) and throughput (less pps) impacted by rules? What about the bare metal CPU usage (could increase since it's processing traffic to match rules)?
&nbsp; &nbsp; - Really don't know... You could build some test scenarios to validate.</li><li>Where/When the rules are processed.
&nbsp; &nbsp; - Don't know... Maybe it is like the DFW rules from NSX-T and they are processed on kernel hooks giving a good performance... But haven't looked for it.</li><li>Can I apply ACLs for an specific VM? Can I apply to uplinks?
&nbsp; &nbsp; - YES! You can!</li></ul><div class="admonition admonition-danger alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</h5></div><div class="admonition-content"><p>Be careful when using API to manipulate trafficRules like this. There are some functionalities that are only available through API! If you create some certain kind of rules using API you may be not able to see it on WEB UI! Worst: No errors are shown, but the rules are still there! If you want to delete or edit them, you'll need to do it using the API itself.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="python-scripts">Python Scripts<a class="hash-link" href="#python-scripts" title="Direct link to heading">​</a></h2><p>The vSphere API described before is commonly used through an SDK previously built by vmware itself. A lot of people use PowerShell SDK (called <a href="https://developer.vmware.com/web/tool/12.5.0/vmware-powercli" target="_blank" rel="noopener noreferrer">PowerCLI</a>). I like the python SDK called <a href="https://github.com/vmware/pyvmomi" target="_blank" rel="noopener noreferrer">pyvimovi</a> which is also used by ansible modules.</p><p>I've uploaded 2 scripts to github. The first one lists rules on DVS and the second creates rules on DVS. Could have been only one, but that's ok...</p><p><a href="https://github.com/liviozanol/vmware_vds_traffic_filter/blob/main/list_vds_portgroup_rules.py" target="_blank" rel="noopener noreferrer"><code>list_vds_portgroup_rules.py</code></a> list rules for a specific portgroup. You pass dvswitch name, portgroup name and rule_id (optional) as argument to the script and all rules for that portgroup is outputted on a JSON formatted string.</p><p><a href="https://github.com/liviozanol/vmware_vds_traffic_filter/blob/main/edit_vds_portgroup_rules.py" target="_blank" rel="noopener noreferrer"><code>edit_vds_portgroup_rules.py</code></a> edit, create and delete rules for a specific portgroup using a JSON file as source. The JSON file needs to have a specific format. In the following example we intended to create a simple TCP rule on port 53 to google DNS. Keep in mind that <a href="https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml" target="_blank" rel="noopener noreferrer">protocol number must follow IANA definition</a>: (this example is also on script help):</p><div class="language-JSON codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-JSON codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "sourceAddress":"any",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "destinationAddress":"8.8.8.8/32",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "sourcePort":"1024-60000",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "destinationPort":"53",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "protocol":"6",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "action":"accept",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "direction":"both",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; "description":"DNS google"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&nbsp; &nbsp; }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>vSphere Distributed Switch (VDS), along with other features like QoS, mark, shaping, LACP, etc. also supports stateless traffic filtering using 5 tuples.</p><p>Since I never tested it on production, I can't recommend you to do so. If you have some case scenarios for this or have already tested this on a production environment, please, feel free to send some data or feedback so I can share with others.</p><p>You could use these scripts to automate VDS using ansible directly (just install pyvimomi) calling it as a "shell" command. Or, you could use it to create an ansible module.</p><p>Any feedback is appreciated.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="vmware vds" term="vmware vds"/>
        <category label="nsx-t" term="nsx-t"/>
        <category label="cloud infrastructure" term="cloud infrastructure"/>
        <category label="security" term="security"/>
        <category label="acl" term="acl"/>
        <category label="traffic filter" term="traffic filter"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 11 - Conclusions]]></title>
        <id>full-stack-it-automation-part-11</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-11"/>
        <updated>2022-02-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Conclusion]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>This series of posts demonstrated how to use some nice tools to build a simple full-stack automation solution that can be &nbsp;used to automate almost everything on your infrastructure.</p><p>The architecture demonstrated is not static and can be modified to best fit a team/company needs.</p><p>You can (and should) separate the API on 2 layers: One to deal with data validation and business rules (this is accessed by the user); One with basic validation, parsing and uploading data on gitlab.</p><p>You can make an audit function, either together on the pipeline/awx or separated. You gather info from your automated element (eg.: router) and compare it with the information on gitlab (reverse parsing it) to be sure that what was sent is really on the automated element.</p><p>You can (and really should) add a bastion host to access your automated elements, and make AWX use, for example, SSH tunnel prior to connecting to the automated element, protecting it even more from undesirable access.</p><p>To build the full-stack automation from scratch, were spent the following estimate hours:</p><ul><li>Automate AWX installation and customization it using its APIs: <strong>~ 8 hours</strong>.<ul><li>Some bugs and CentOs deprecated version really impacted on this. Had some previous knowledge on how to use AWX API, which helped.</li></ul></li><li>Automate installation and customization of Gitlab, Gitlab CI and 2 Hashicorp Vault: <strong>~ 4 hours</strong>.<ul><li>These are pretty straightforward.</li></ul></li><li>Build the ansible playbook and test it: <strong>~ 6 hours</strong>.<ul><li>Jinja templates and language are difficult to understand. Had previous knowledge on playbooks, but very few on jinja templates.</li></ul></li><li>Build the API using <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">Python FastAPI</a>: <strong>~ 4 hours</strong><ul><li>Had some basic knowledge of python dev and zero knowledge on Fast API. Very nice framework with easy learning curve.</li></ul></li><li>Build and test the main gitlab CI/CD script which is responsible to get modified data and push to AWX: <strong>~ 1,5 hour</strong>.<ul><li>Had some previous knowledge on gitlab-CI.</li></ul></li><li>Build the CI/CD for the APIs, Bastion Host and Web Interface: <strong>~ 2 hours</strong><ul><li>Had some previous knowledge on gitlab-CI.</li></ul></li><li>Make the web interface using basic React Admin elements: <strong>~ 4 hours</strong>.<ul><li>Had some previous knowledge on React Admin.</li><li>Adjusting the queries from/to the API took most of the time.</li><li>Making the basic list/edit page was easy (~ 2 hours?). You can see that <a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/fullstack-ui/src/wanSite.js" target="_blank" rel="noopener noreferrer">the code is simple</a>.</li><li>Making complex things requires good knowledge on JS/React JS.</li></ul></li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Feel free to contact me by e-mail: livio at zanol.com.br to further discuss this subject.</p></div></div>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
        <category label="react admin" term="react admin"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 10 - Demo - UI]]></title>
        <id>full-stack-it-automation-part-10-demo-ui</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-10-demo-ui"/>
        <updated>2022-02-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Web Interface]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="web-interface">Web Interface<a class="hash-link" href="#web-interface" title="Direct link to heading">​</a></h2><p>In this section we will build our web interface. Users can use it to get and update info from their WAN sites in a friendly interface. Note that using web interface is not mandatory. In fact, the web page will only convert data to/from API to show on a page, but users still request our API directly and can use it to make its changes. In some aspect this is good, since you give option to users to use any other tool to interact with our solution. They can use for example <a href="https://www.postman.com" target="_blank" rel="noopener noreferrer">postman</a>, <a href="https://curl.se" target="_blank" rel="noopener noreferrer">curl</a>, ansible, terraform, or even building its own web interface if they want to.</p><p>Will be used <a href="https://marmelab.com/react-admin" target="_blank" rel="noopener noreferrer">react admin</a> as framework to build our UI. Their community version is very complete and allow us to build our pages (if they are basic ones) pretty easy. The Tutorial and Manual are very complete, and if want to deep dive in it go check it out.</p><p>React admin is a framework built in <a href="https://pt-br.reactjs.org" target="_blank" rel="noopener noreferrer">React</a> that lets you build a complete admin dashboard for almost anything using react and Javascript/Typescript (you can also use other <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer">NPM</a> modules). It integrates with APIs pretty simple and also have a lot of pre-built fields/functions that makes the job of building dashboards much more simple. As UI components, it uses the great <a href="https://mui.com/" target="_blank" rel="noopener noreferrer">Material UI</a> providing a great visual experience.</p><p>It's not part of this post to explain how Javascript/Typescript, NPM or React works as this is a whole world for itself. If want you can learn more about them somewhere else on Internet.</p><p>As always, all files generated on this section (and on previous) are on full-stack automation github repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>), so you don't need to create it yourself again.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Please note that I'm not a developer. You shouldn't trust my code blindly (in fact, any code). But feel free to use it, change it and send me angry feedbacks and comments.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="coding-the-interface">Coding the interface<a class="hash-link" href="#coding-the-interface" title="Direct link to heading">​</a></h2><p>To build our simple web interface using React Admin we need basically these things:</p><ul><li>A file with our <a href="https://marmelab.com/react-admin/Authentication.html" target="_blank" rel="noopener noreferrer">Auth provider</a> that will receive username/pass as input and validate user permission on the API. Will be named <code>authProvider.js</code></li><li>A file with our <a href="https://marmelab.com/react-admin/DataProviders.html" target="_blank" rel="noopener noreferrer">Data provider</a> that will query our API and transform the JSON response from it to a format compatible with react admin. If needed, you can also convert data from react admin format to a format understood by the API before you send to the API (we have done this). Will be named <code>dataProvider.ts</code></li><li>A file with our Wan Sites functions that will basically have 2 main exported functions: 1 with a <a href="https://marmelab.com/react-admin/List.html" target="_blank" rel="noopener noreferrer">List</a> of Wan Sites and 1 with the <a href="https://marmelab.com/react-admin/CreateEdit.html" target="_blank" rel="noopener noreferrer">Edit(Update)</a> view that user will use to edit a Wan Site configuration. We also added react admin simple form validation for each field on the Edit view so user can have a better experience, but this is not required since our API <em>must</em> validate the data also. This file will be named <code>wanSite.js</code></li><li>The <code>App.js</code> file that will put everything together and make the react admin app available to the user.</li></ul><p>On the demo we will use async site update. Once the user submits a change, after validation, data is updated on gitlab and user can make other tasks. So, we need a way to show users if their submitted changes have been implemented on equipment or not and we will create another file for this: <code>jobList.js</code>. This file is a custom React file that shows a table of the last 5 jobs submitted by users and its status. It will be used as an <a href="https://marmelab.com/react-admin/CreateEdit.html#aside-component" target="_blank" rel="noopener noreferrer">Aside Component</a> on the Edit View that will be shown on the right side of this page to the user.</p><p>If you follow <a href="https://marmelab.com/react-admin/Tutorial.html" target="_blank" rel="noopener noreferrer">react admin tutorial</a> after you create your react app, edit App.js to import authProvider, dataProvider and wanSite, obviously create these files (and jobList), make the ajustment on resources and authprovider on App.js and that's it. You can run your app (<code>yarn start</code> or <code>npm run start</code>) to see it working. If you have access to the API from the computer where you are running the react admin interface you can start to use the app. Login with "client_a_user" (user/pass), "client_b_user"(user/pass) and "admin" (user/pass) to see the differences.</p><p>If you look at the source codes of the <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/fullstack-ui/src" target="_blank" rel="noopener noreferrer">files</a> you will see that coding basic things using react admin is pretty simple and the documentation and examples help a lot. But as you start to customize elements, things can get very complicated. If you take a look at <code>jobList.js</code> that is pratically a custom built element using very few react admin elements, you will see how messy things can become. Either way, React Admin always tries to make things simpler to you and sure is much more easier than build your own admin dashboard from scracth.</p><p>UI demonstration after wall is installed and configured
<img loading="lazy" alt="UI demonstration after wall is installed and configured" src="/assets/images/UI-02e4ae8364f73dcacc1172f2c80975d5.gif" width="1033" height="532" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="publishing-our-webpage">Publishing our webpage<a class="hash-link" href="#publishing-our-webpage" title="Direct link to heading">​</a></h2><p>Just like our API, everything will be auto deployed by our gitlab runner using a CI/CD pipeline.</p><p>We will again use the same gitlab runner that calls AWX. On a production environment, the UI and API runner should be separated.</p><p>Since we will be using React Admin for our UI, we will use <a href="https://www.npmjs.com/" target="_blank" rel="noopener noreferrer">NPM</a> to build and install our App. Our repo will contain a <code>packages.json</code> file that is read by npm and installs the required packages and its dependencies. The output from this build are simple HTML, CSS and JS files that you can even run on your local computer. The CI/CD pipeline will just get these files, and build a simple nginx docker image with then inside, publishing our app just like any simple simple HTML/JS application.</p><p>Will be created 1 repository for our react admin source files and packages.json. Gitlab runner will watch this repo and update our UI container everytime we modify it.</p><p>Again, our CI/CD pipeline will be VERY simple, without even testing our application before deploy. Please note that adding more stages with some good tests, validation, approval is very recommended. For simplicity, the update process will be disruptive (stop old containers and running new ones). On production environment, obviously, you should make something more suitable for your needs.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The installation/configuration script will try to guess which IP address is the pyshical IP and change App.js to use it as a dataprovider. If its wrong, you can just update App.js file with the correct IP, either using git operations or gitlab web UI.</p></div></div>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
        <category label="react admin" term="react admin"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 9 - Demo - API]]></title>
        <id>full-stack-it-automation-part-9-demo-api</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-9-demo-api"/>
        <updated>2022-01-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Service API]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="service-api">Service API<a class="hash-link" href="#service-api" title="Direct link to heading">​</a></h2><p>In this section we will build our service API. It's responsible to <em>receive direct user request</em>, check permissions and if authorized, read and modify files on our gitlab repository.</p><p>We will use python as the API language, but as explained before, you could use any language you want that can be built to receive and process HTTP requests. To make things a little faster, will be used <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI framework</a>. We will try to keep things as simple as possible for the demo, and some funtions may have some minor issues, but on your journey to build a production API you should take more cautions and make things as secure as possible.</p><p>After building the API, users should be able to access it using user/pass and view or change information from their WAN site.</p><p>All files generated on this section (and on previous) are on full-stack automation github repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>), so you don't need to create it yourself again.</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Please, note that in this demo we will use Hashicorp Vault 2 itself to store and verify users authentication and authorization with simple Key/Value and this is not safe/recommended at all. We will create 3 KV secrets in it, each one containing the username, the password and the tenants that each user can access. API simply queries this data and check if passwords match and checks which tenant users belong. Also, queries to the API will use a Basic HTTP Authentication using provided user/pass and that is also not safe and should not be used on production.</p><p>On a production environment you <em>MUST</em> use other method of authentication/authorzation.</p><p>If you already have an auth system you should consider integrating your APIs with it. If its an <a href="https://openid.net/connect/" target="_blank" rel="noopener noreferrer">OIDC</a>/<a href="https://oauth.net/2/" target="_blank" rel="noopener noreferrer">OAuth2</a> even better, you can use its own specification to authorize and get users tenant based on custom scopes and it also has it own mean of temporary token exchange to enhace security.</p><p>If you want to build your own Auth, you need to get this information elsewhere. I like <a href="https://www.youtube.com/watch?v=d4Y2DkKbxM0" target="_blank" rel="noopener noreferrer">this</a> simple tutorial using React/GO that even uses JWT to exchange messages to/from API. You could also use some free OIDC as <a href="https://www.ory.sh/hydra/" target="_blank" rel="noopener noreferrer">Ory</a> to build on premise auth system, and we could have done this on this demo, but would make our demo too big, more than it already is. Python FastAPI have nice features to easily integrate with oAuth/OIDC.</p></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Please note that I'm not a developer. You shouldn't trust my code blindly (in fact, any code). But feel free to use it, change it and send me angry feedbacks and comments.</p></div></div><p>API source code for our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/api" target="_blank" rel="noopener noreferrer">here</a></p><p>Bastion configuration for our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/bastion" target="_blank" rel="noopener noreferrer">here</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="api-structure">API structure<a class="hash-link" href="#api-structure" title="Direct link to heading">​</a></h2><p>When you build APIs you almost always want to think your serevice on a <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank" rel="noopener noreferrer">CRUD</a> way:</p><ul><li>How do you Create a service instance;</li><li>How do you Read/List your serivce instances;</li><li>How do you Update a service instance;</li><li>How do you Delete a service instance.</li></ul><p>Remebering our <a href="/full-stack-it-automation-part-6-demo-scenario">service definition</a>, our service is a WAN site LAN customization that users can change LAN IP addresses, set helper address, ACLs and some other infos. Thinking in a CRUD way would be something like this:</p><ul><li>Create/Enable a WAN site LAN interface (or install/activate/comission whole WAN site CPE, including its PE interface).</li><li>Read/List WAN sites LAN configuration.</li><li>Update/Change WAN sites LAN configuration.</li><li>Delete/Disable a WAN site LAN interface (or desinstall/descomission whole WAN site CPE).</li></ul><p>As you can see, Creating/Deleting our service could/should be a staff/operator activity, and we will not cover it on the demo, but if you want, you sure can! You would need to create playbooks involved on these tasks, change your gitlab runner to indetify when to execute each playbook (eg.: by a commit message?), create a way to authenticate/authorize your operators (could even use our Vault user/pass/tenant sctructure - just for a demo, please) and create these functions on the API/UI.</p><p>Considering the info above, we will build a <a href="https://restfulapi.net/" target="_blank" rel="noopener noreferrer">REST API</a> that receives either a HTTP GET(read/list) or PUT(update) request. The API will be stateless and you can scale it horizontally.</p><p>We will also use a bastion container using <a href="https://www.nginx.com/" target="_blank" rel="noopener noreferrer">NGINX</a> that receives our requests and identify to which API endpoint it should redirect it based on path (eg.: <a href="http://127.0.0.1/wan_site" target="_blank" rel="noopener noreferrer">http://127.0.0.1/wan_site</a> should go to our demo API). Keep in mind that each API container is responsible for its own auth function, our bastion hosts only pass our requests to the API based on the URL path (eg.: wan_site to wan_site APIs).</p><p>You could also add some cache layer if you want using something like <a href="https://redis.io/" target="_blank" rel="noopener noreferrer">redis</a> if you have some complex automation. </p><p>Everything will be auto deployed by our gitlab runner using a CI/CD pipeline.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You could, and it is a good practice, create 2 separated APIs layers for any specific service deployed. The first one deals with data validation, business rules and other things related with user relationship and frontend. This is the API accessed by users and the web interface. Another one would be responsible with basic validation, parsing, uploading data on gitlab and other things related with automation itself. The first one only talks to the second one and never touches any piece of your automation infrastructure. You could also add an auth for this API to API conversation using JWT for example to secure it better.</p></div></div><p>The following picture demonstrate our expanded API layer for the demo (we will build a bastion host container and only one wan_site API container, but could be easilly scalable):
<img loading="lazy" alt="API layer architecture" src="/assets/images/api_arch-2bf5d3a520f0324630d2c7f2851ad246.svg" width="457" height="332" class="img_E7b_"></p><p>Demo with API running
<img loading="lazy" alt="API" src="/assets/images/api-d1e47fa284844fad2bff304f33bb000e.gif" width="605" height="338" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="bastion-nginx-configuration">Bastion NGINX configuration<a class="hash-link" href="#bastion-nginx-configuration" title="Direct link to heading">​</a></h2><p>We will keep bastion host configuration as simple as possible, and you should enhance its configuration if needed and can read more about NGINX configuration <a href="https://docs.nginx.com/nginx/admin-guide" target="_blank" rel="noopener noreferrer">here</a>.</p><p>We will use <a href="https://hub.docker.com/_/nginx" target="_blank" rel="noopener noreferrer">official alpine nginx docker image</a> and create 3 files:</p><ul><li><code>apis.conf</code> that will have our proxy_pass redirecting requests containing wan_sites on path to our API. For every API you create, just add a line like this, redirecting to the correct API endpoint. 127.0.0.1 will be replaced by our script with the real IP from our host.</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">location /wan_sites </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    proxy_pass http://127.0.0.1:10042/wan_sites</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include /etc/nginx/conf.d/APIs/default_proxy.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>default_proxy.conf</code> that will have our common proxy configuration for every API:</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_http_version  </span><span class="token number">1.1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_cache_bypass  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$http_upgrade</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header Host               </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Real-IP          </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$remote_addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-For    </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$proxy_add_x_forwarded_for</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Proto  </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$scheme</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Host   </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_set_header X-Forwarded-Port   </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$server_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_connect_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_send_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">proxy_read_timeout </span><span class="token number">180</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>default.conf</code> that is basically own nginx default.conf just adding include clause to import our <code>apis.conf</code>:</li></ul><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen       </span><span class="token number">80</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">::</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">:80</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    server_name  localhost</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    include /etc/nginx/conf.d/APIs/*.conf</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="api-code-and-server">API code and server<a class="hash-link" href="#api-code-and-server" title="Direct link to heading">​</a></h2><p>As stated on the beginning we will use <a href="https://fastapi.tiangolo.com/" target="_blank" rel="noopener noreferrer">FastAPI framework</a> to build our API. We will publish it using <a href="https://www.uvicorn.org/" target="_blank" rel="noopener noreferrer">Uvicorn</a> on a container.</p><p>You could scale it simply creating more containers and changing nginx bastion host config (if not on kubernetes) to load balance between them (please use <a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/http-health-check" target="_blank" rel="noopener noreferrer">healthchecks</a>), or use some more structured approaches using <a href="https://fastapi.tiangolo.com/deployment/server-workers" target="_blank" rel="noopener noreferrer">gunicorn</a> or even more complex structures with cache layers.</p><p>The created code is simple and structured in a approach more close to Functional Programming rather than Object Oriented (OOP). It has 3 files:</p><ul><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/main.py" target="_blank" rel="noopener noreferrer">main.py</a></li><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/check_permissions.py" target="_blank" rel="noopener noreferrer">check_permissions.py</a></li><li><a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/wan_api_functions.py" target="_blank" rel="noopener noreferrer">wan_api_functions.py</a></li></ul><p>main.py is responsible to handle the HTTP requests, check if user have permissions, and send the requests to the appropriate functions that processes them. If a user send a GET request to the path "/wan_sites" main.py, after checking permissions, will send the request to the function that get sites JSON data from gitlab and return them.</p><p>check_permissions.py is responsible to get credentials from the HTTP Authorization header, check if they match the stored one on vault and get the tenants that user has permission. For EVERY request the Auth Header <em>must</em> be sent to the API and requests are only processed if they are authorized on vault. Separating the permission check in functions like this, allow us to easially change how this check is done to use other auth providers like OIDC. The function can do whatever you want, just needing to return what tenants does that user has permission.</p><p>wan_api_functions.py is our principal file and is the one that we work the most coding. It contains all functions related to the API objective itself. It has functions to get data from gitlab, to list pipeline jobs and its status, to receive UPDATE requests from user and validate it and so on. The biggest and most workly function here is the one that validate the user data on a UPDATE requests. It has a lot of strictly validating rules based on our data definition and is the function that you need to have most care and takes more time to build.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>We have created a new HTTP GET path on our API that will list the last x pipeline jobs and its status. This can be used by the user to check if its UPDATE is finished or not and will also be used on the web UI.</p><p>On the UPDATE API path we have configured the function to accept a query string that will make the UPDATE syncronous (wait until the job pipeline is finished) or asyncronous (just UPDATE gitlab file with user data).</p><p>We have made a separate validation function for user data because we wanted to make some complex data validation besides simple string/int/boolean/regex one. FastAPI has some good options for simple data validation using strong integration with <a href="https://pydantic-docs.helpmanual.io/" target="_blank" rel="noopener noreferrer">pydantic</a></p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="deploying-bastion-host-and-api-using-gitlab-runner">Deploying Bastion host and API using gitlab runner<a class="hash-link" href="#deploying-bastion-host-and-api-using-gitlab-runner" title="Direct link to heading">​</a></h2><p>As stated before, we will use the same gitlab runner that call AWX to automatic deploy our API and bastion/reverse proxy. On a production environment, the API/bastion gitlab runner should be separated.</p><p>Will be created 2 repositories on gitlab: 1 for our bastion host and another for our API. Gitlab runner will watch these repos and update our API or bastion container everytime we modify it.</p><p>Again, <a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/api/.gitlab-ci.yml" target="_blank" rel="noopener noreferrer">our CI/CD pipeline</a> will be VERY simple, without even testing our application before deploy. Please note that adding more stages with some good tests, validation, approval is very recommended for the APIs and also for UI. For simplicity, also the bastion/API update process will be disruptive (stop old caontainers and running new ones), but you can easilly achieve high availability for the APIs scaling them horizontally and Load Balancing with healthchecks on bastion hosts. Updating the bastion/reverse proxy container  without disrupting it thougha is more difficult.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="testing-the-api-witch-curl">Testing the API witch CURL<a class="hash-link" href="#testing-the-api-witch-curl" title="Direct link to heading">​</a></h2><p>When the API is deployed you can test its functions using curl like below:</p><ul><li><p>Listing Client A WAN sites
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites | jq</code></p></li><li><p>Getting one specific site from Client B:
<code>curl --user client_b_user:client_b_user 127.0.0.1:10042/wan_sites/site_3 | jq</code></p></li><li><p>Updating info for site 1 from Client A asyncronous (please, create CHANGED_FILE.json with your changes):
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites/site_1?sync=0 -X PUT --data @demo/api/update_test_files/CHANGED_FILE.json</code></p></li><li><p>List the last 10 jobs for site 1:
<code>curl --user client_a_user:client_a_user 127.0.0.1:10042/wan_sites/site_1/jobs?number_of_jobs=10 | jq</code></p></li></ul>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
        <category label="fastapi" term="fastapi"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 8 - Demo - Runner]]></title>
        <id>full-stack-it-automation-part-8-demo-gitlab-runner</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-8-demo-gitlab-runner"/>
        <updated>2022-01-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Gtilab-CI/Gitlab Runner]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="gtilab-cigitlab-runner">Gtilab-CI/Gitlab Runner<a class="hash-link" href="#gtilab-cigitlab-runner" title="Direct link to heading">​</a></h2><p>In the previous post we have defined our structured data, stored it on gitlab, created our playbooks and inventories and imported them on AWX. Now we will prepare our CI/CD pipeline to monitor changes on our data on gitlab and tell AWX to execute our playbook. Gitlab runner will be responsible for these tasks, registering on our gitlab projects/group and executing a series of tasks once our data is changed, calling AWX API to run our workflow playbook passing our modified data and monitoring our job in execution also using AWX API.</p><p>All files generated on this section (and on previous) are on full-stack automation github repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>), so you don't need to create it yourself again.</p><p>Everytime our gitlab repository is changed, gitlab-ci will get the contents of our wan_site_cfg.json file and send it to AWX as a variable, calling a job/playbook/template or a workflow that will implement the changes on our equipments.</p><p>After concluding this section you will have something like a GitOps for our wan automation service. If you change some information from your WAN site on gitlab repo, AWX will implement it on equipment.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>Please, note that in this demo we installed gitlab runner using "privileged" mode and also mapped docker host socket to the container. This means that gitlab runner container can virtually execute any docker command directly into our docker host, stopping, starting, running and removing ANY container (including AWX and itself). This is NOT a good practice, but we have made this way because we will use gitlab runner to also start our APIs and UI container on the demo.</p><p>In a production environment, as stated before, its a good practice to separate functions on different hosts (user APIs, UI and its gitlab runner CI/CD on a isolated place from AWX playbooks and its own gitlab runner CI/CD) and if possible creating/using more than one gitlab. The gitlab runner that starts our AWX jobs, does not need privileged access and only needs to connect to AWX and gitlab APIs, so you don't need to map docker host socket neither use privileged mode on this runner and could use <a href="https://github.com/jpetazzo/dind" target="_blank" rel="noopener noreferrer">docker in docker</a> to run your curl/bash commands or execute commands directly on gitlab runner container.</p></div></div><p>Every file for Gitlab Runner config to our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/gitlab-ci" target="_blank" rel="noopener noreferrer">here</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="registering-our-runner">Registering our runner<a class="hash-link" href="#registering-our-runner" title="Direct link to heading">​</a></h2><p>To register our gitlab-CI/runner we first need a registration token and we will get this token using gitlab API. After getting this token we will <code>docker exec</code> a command on gitlab runner container to register it on the wan_site group. After runner is registered, everytime a file is changed on any repository inside wan_site group, gitlab runner will look for a .gitlab-ci.yml file and use it to start our CI/CD pipeline.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-our-gitlab-ciyml">Building our .gitlab-ci.yml<a class="hash-link" href="#building-our-gitlab-ciyml" title="Direct link to heading">​</a></h2><p>Will be used a quite simple pipeline with only 1 stage that gets required credentials from our Vault 2 and calls AWX API to start our workflow job template and monitors it until it stops. You could insert other stages to improve your pipeline and you should consider this if you are making more complex automations. Some examples for network automation:</p><ul><li>Add a <a href="https://vincent.bernat.ch/en/blog/2021-network-jerikan-ansible" target="_blank" rel="noopener noreferrer">Jerikan</a> stage to to parse your data and send it already parsed to AWX (needs to change the playbook)</li><li>Add a <a href="https://www.batfish.org/" target="_blank" rel="noopener noreferrer">batfish</a> stage to validate your config after parsing it.</li><li>Add a <a href="https://netsim-tools.readthedocs.io/" target="_blank" rel="noopener noreferrer">network simulation tool</a> stage to test your parsed configs in a lab.</li><li>Add a "homologation" test stage, running another playbook (or changing hostname or sending to another specific AWX) that will implement your changes on some lab equipment and validate its functionalities. Could either be physical equipments or lab routers running on a qemu emulation (see <a href="https://www.eve-ng.net/" target="_blank" rel="noopener noreferrer">eve-ng</a> for a nice solution)</li><li>Add an approval stage making the pipeline wait until an operator access gitlab and approves the changes (or build an API/UI for this step!).</li></ul><p>Our 1 stage pipeline will use a basic alpine image from docker hub and we will install curl and jq on it to use on our APIs calls. You could (and I think it's a good practice) build your own image only with basic Shell functionalities, curl, jq and other tools that you use on each stage.</p><p>To query Vault and get AWX user/pass we need a token and we'll store it using the gitlab variable as 'masked'. It's the only presumably sensible information that will be stored on gitlab. Any other sensitive data that will be needed must be stored on Vault and queried from it on run time. You should restrict the access to this access token and for AWX user/pass on hashicorp Vault to only allow queries from gitlab ip address, but we won't do this on the demo. If you are on a production environment I hope you built Vault and installed it already on an isolated environment with restricted L3/L4 access and will also make the application restriction mentioned. </p><p>We will also use 2 more variables on gitlab: Vault URL and AWX IP Address/Port. You could store the AWX ip/port on Vault if you want...</p><p>After getting the AWX credentials, our pipeline will call AWX API to run our playbook, getting the modified data from wan_site_data.json on the repository and simply passing it as an extra_vars to AWX.</p><p>At the end we have a simple while loop that keeps querying the AWX API to get the job status and either exit 0 (if the job is successful) or 1 (if it fails).</p><div class="language-yml codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-yml codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> alpine</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">3.15.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">before_script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">#Installing curl and jq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> which curl </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> (apk </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">no</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cache add curl)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> which jq </span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token punctuation" style="color:rgb(248, 248, 242)">|</span><span class="token plain"> (apk </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">no</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">cache add jq)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">run</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">script</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> PLAYBOOK_NAME="wan_automation_workflow_template"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#Getting credentials from vault</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"CURL_RESULT=`curl -sk -H \"X-Vault-Token: $VAULT_TWO_TOKEN\" \"$VAULT_TWO_URL/v1/secret/data/awx_secret\"`"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AWX_USER=`echo $CURL_RESULT | jq -r .data.data.awx_user`"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"AWX_PASS=`echo $CURL_RESULT | jq -r .data.data.awx_pass`"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> AWX_URL="https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//$AWX_USER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">$AWX_PASS@$AWX_ADDRESS_PORT"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#Querying AWX API to get workflow job template ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"JOB_TEMPLATE_ID=`curl -sk $AWX_URL/api/v2/workflow_job_templates/?search=$PLAYBOOK_NAME | jq .results[].id`"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#Calling AWX API to run our workflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"JOB_ID=`curl --header \"Content-Type: application/json\" -sk $AWX_URL/api/v2/workflow_job_templates/$JOB_TEMPLATE_ID/launch/ --data \"{\\\"extra_vars\\\":$(cat wan_site_data.json)}\" | jq .id`"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#Monitoring workflow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#COUNT is used as a protection so we don't have ifnite loops</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> COUNT=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> MAX_COUNT=80</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">&gt;</span><span class="token scalar string" style="color:rgb(255, 121, 198)"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      while true; do</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        JOB_STATUS_TEXT=`curl -sk $AWX_URL/api/v2/workflow_jobs/$JOB_ID/ | jq -r .status`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        if [ "$JOB_STATUS_TEXT" == "successful" ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          exit 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        if [ "$JOB_STATUS_TEXT" == "failed" ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          exit 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        sleep 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        COUNT=$(( COUNT + 1 ))</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        if [ "$COUNT" -gt "$MAX_COUNT" ]; then</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          echo "protection against infinite loop reached. aborting"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">          exit 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">        fi</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token scalar string" style="color:rgb(255, 121, 198)">      done;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 7 - Demo - AWX]]></title>
        <id>full-stack-it-automation-part-7-demo-awx</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-7-demo-awx"/>
        <updated>2022-01-10T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Creating Playbooks and complements]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="creating-playbooks-and-complements">Creating Playbooks and complements<a class="hash-link" href="#creating-playbooks-and-complements" title="Direct link to heading">​</a></h2><p>In the previous post we have defined our structured data and created sample projects on gitlab. Now that our data structure is defined we can start to build our playbooks and templates. In this section we'll build our inventory, templates, workflow and playbook.</p><p>All files generated on this section (and on previous) are on full-stack automation github repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>), so you don't need to create it yourself again.</p><p>Ansible/AWX are only the executor of automation tasks and they are never accessed by end-users. So, we don't need to have separation/segregation on a client basis on AWX and you don't need to carry about this. More information about AWX and its role on this architecture can be found <a href="/full-stack-it-automation-part-4-awx">here</a></p><p>Everytime our gitlab repository is changed, gitlab-ci will get the contents of our wan_site_cfg.json file and send it to AWX as a variable, calling a job/playbook/template or a workflow that will implement the changes on our equipments.</p><p>After configuring AWX, you should be able to start jobs on it to implement changes on remote WAN sites.</p><p>Every file for AWX config to our demo can be found <a href="https://github.com/liviozanol/full-stack_automation/tree/master/demo/awx" target="_blank" rel="noopener noreferrer">here</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="inventory">Inventory<a class="hash-link" href="#inventory" title="Direct link to heading">​</a></h2><p>On AWX, you can have different inventories for each Project. Considering this, let's define our project being our service in a way that for each service we can have different jobs/playbooks, templates and inventories. You could also use any separation you like (per your company technical areas - good for permission control, per element types, per automation types, etc.).</p><p>If you need to use some kind of jump/bastion host to access your devices, you can also define it on this file with variables for all hosts, group of hosts or single hosts. You don't need to (and shouldn't) keep a password/key for the SSH access here, you can just point to a place where the key will be and get it from hashicorp vault. <a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to" target="_blank" rel="noopener noreferrer">read more</a></p><p>Since we'll be using a lot of YAML I think it's nice to build the inventory also using YAML, but feel free to use INI as well looking at <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html" target="_blank" rel="noopener noreferrer">reference guide</a>.</p><p>Our YAML for this wan_site automation project can be like this:</p><div class="language-yaml codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-yaml codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token key atrule">all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">vars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">dumb_var</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> you_can_have_you_global_var_here_including_ssh_args</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ansible_user</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> test </span><span class="token comment" style="color:rgb(98, 114, 164)">#ansible SSH user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ansible_ssh_common_args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">'-o ControlPersist=60s -o ConnectTimeout=300 -o StrictHostKeyChecking=no'</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">#just to test... on production, remove this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ansible_ssh_private_key_file</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ./id_rsa_fullstack.key </span><span class="token comment" style="color:rgb(98, 114, 164)">#Key to use to login</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token key atrule">children</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ROUTERS_US</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">vars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">dumb_var2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> you_can_have_you_group_var_here_including_ssh_args</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">site_1</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">vars</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            </span><span class="token key atrule">dumb_var3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> you_can_have_you_host_var_here_including_ssh_args</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 127.0.0.66 </span><span class="token comment" style="color:rgb(98, 114, 164)">#device IP that accepts SSH from ansible (or from bastion/jump host)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">2222</span><span class="token plain"> </span><span class="token comment" style="color:rgb(98, 114, 164)">#SSH listenport</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> network_cli </span><span class="token comment" style="color:rgb(98, 114, 164)">#ansible connection type</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_network_os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> ios </span><span class="token comment" style="color:rgb(98, 114, 164)">#variable with device OS that can be used later on our playbook to convert a propper template file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">site_3</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10322</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> network_cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_network_os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> junos</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token key atrule">ROUTERS_ASIA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token key atrule">hosts</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">site_2</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10222</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> network_cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_network_os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> eos</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token key atrule">site_4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> 127.0.0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_port</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> </span><span class="token number">10422</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_connection</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> network_cli</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          </span><span class="token key atrule">ansible_network_os</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain"> iosxr</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In our example inventory files, remote sites are separated by geographical area, but you can use any separation you want. You can even have a global inventory file maintained by another team that is updated on gitlab by an ansible playbook itself (imagine an initial deploy phase).</p><p>The important thing to note here is that the "hosts" names are the ones used to identify on which host jobs/playbooks need to be executed. So, in our demo, <em>hosts names on inventory (e.g.: site_1) must match the project name on gitlab</em>. You could use a field on the structured data (or another file) for this and make an internal name/id that is not seen nor edited by the user, but let's keep it simple on the demo.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="building-playbooks-and-templates">Building Playbooks and templates<a class="hash-link" href="#building-playbooks-and-templates" title="Direct link to heading">​</a></h2><p>We will organize our playbooks in a way that we can run commands on equipment depending on its Operating System/type. You could do something more structured using templates, correct ansible modules for each command block (e.g.: acl, interface config, etc.) and also use roles functions separated by OS/type, but I think that a more simple approach is better for maintenance and make you less dependent on ansible and its own organization itself. A point to remember is that, since every change on infrastructure will be made through an API that has strong data constraints, data is already more validated than if we called ansible directly or modifying it via gitlab.</p><p>For each type of OS we will have 1 playbook (e.g.: ios_playbook.yml) and 1 template. They will be responsible to convert (a.k.a. parse) our structured JSON data received as variable to commands that needs to be executed on equipment. Since ACLs commands are complex to parse, we'll be using a template to convert it. It receives our ACLs entry and converts it to CLI commands. You could also use something like <a href="https://vincent.bernat.ch/en/blog/2021-network-jerikan-ansible" target="_blank" rel="noopener noreferrer">Jerikan</a> on the gitlab CI and deliver your data already parsed to ansible so it only executes an action plan instead of parsing.</p><p>We will also have a "parent" playbook that simply point to the correct OS playbook depending on "ansible_network_os" variable and use "import_playbook" to import the correct os playbook and a dumb start.yml playbook that only register "ansible_network_os" variable to use on "import_playbook" since we can't access ansible_network_os before import_playbook. These 2 playbooks are the one that we will create job templates on AWX. We will create a workflow template to link these two playbooks.</p><p>In this demo we'll only construct an IOS playbook (also runs on IOS XE), but the concept is the same for any OS. Once the workflow and these 2 job templates are created on AWX, to add support to other OSes, all you need to do is to add specific OS playbooks/templates to gitlab repo.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>AWX latest versions have changed a lot from some previous one. Now, playbooks are run on a AWX "Execution Environment" (EE) that basically is a custom container image containing commands and python modules needed. Fortunately, AWX already has a default EE with some modules. Sadly, the default EE doesn't have netaddr python module needed to make some complex network operations more simple (eg.: creating wildcard mask from a normal mask), so we added a "pip install netaddr" as the first task on our playbook and delegated it to localhost.</p><p>In a production scenario you should consider building your own EE image with the netaddr module. Or maybe, when/if you build your production environment some guy on AWX EE github repo recognize this problem and accept a pull request inserting this module by default. See <a href="https://github.com/ansible/awx-ee/issues/90" target="_blank" rel="noopener noreferrer">this issue</a></p></div></div><p><code>ios_playbook.yml</code> example - only modifying the first interface from the JSON file submitted:</p><div class="language-YAML codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-YAML codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">---</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- name: Create ACLs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  hosts: '{{ site_id }}'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  gather_facts: no</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  tasks:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  - name: Main Block</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    block:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: pip install netaddr (really disagree how red hat manage their products...). Either I do this or create a custom Execution Enviroment....</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ansible.builtin.shell: pip install netaddr</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        delegate_to: 127.0.0.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Parsing in and out ACEs and setting fact</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ansible.builtin.set_fact:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          in_aces: "{{ lookup('template', './ios_template.j2', template_vars=dict(aces=lan_interfaces[0].in_acl)).splitlines() }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          out_aces: "{{ lookup('template', './ios_template.j2', template_vars=dict(aces=lan_interfaces[0].out_acl)).splitlines() }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        delegate_to: localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Get running config interface section</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          commands:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - show running-config | sec interface {{ lan_interfaces[0].interface_name }}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        register: acl_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Get ACL IN Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ansible.builtin.set_fact:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          in_acl: "{{ acl_name.stdout_lines[0] | select('match', '^\\s*ip\\s+access-group\\s+(.*)in') | map('regex_replace', '^\\s*ip\\s+access-group\\s+(.*)\\s+in.*$','\\1') }}" </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          #this regex will capture the ACL name (a string between word 'access-group' and word 'in')</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Get ACL OUT Name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ansible.builtin.set_fact:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          out_acl: "{{ acl_name.stdout_lines[0] | select('match', '^\\s*ip\\s+access-group\\s+(.*)out') | map('regex_replace', '^\\s*ip\\s+access-group\\s+(.*)\\s+out.*$','\\1') }}" </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      #To get ansible_date_time and epoch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - setup:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          gather_subset:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - min</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      #- debug:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      #    var: vars</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      #To get ansible_date_time and epoch</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Creating IN ACL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "{{ in_aces }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          parents: "ip access-list extended wan_site_{{ ansible_date_time.epoch }}_in"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Creating OUT ACL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            "{{ in_aces }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          parents: "ip access-list extended wan_site_{{ ansible_date_time.epoch }}_out"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Attaching ACL to interface</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - "ip access-group wan_site_{{ ansible_date_time.epoch }}_in in"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - "ip access-group wan_site_{{ ansible_date_time.epoch }}_out out"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          parents: "interface {{ lan_interfaces[0].interface_name }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Deleting old IN ACL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - "no ip access-list extended {{ in_acl[0] }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        when: in_acl[0] is defined and in_acl[0] | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      - name: Deleting old OUT ACL</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            - "no ip access-list extended {{ out_acl[0] }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        when: out_acl[0] is defined and out_acl[0] | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    when: lan_interfaces[0].in_acl is defined and lan_interfaces[0].in_acl | length &gt; 0 and lan_interfaces[0].out_acl is defined and lan_interfaces[0].out_acl | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">- name: Setting other changes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  hosts: '{{ site_id }}'</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  gather_facts: no</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  tasks:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: Parsing "IP/Mask" to "IP Mask (dot decimal formation)"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      set_fact:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ip_mask: "{{ lan_interfaces[0].ip_address | ansible.netcommon.ipaddr('address') }} {{ lan_interfaces[0].ip_address | ansible.netcommon.ipaddr('netmask') }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      delegate_to: localhost</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      when: lan_interfaces[0].ip_address is defined and lan_interfaces[0].ip_address | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: Changing IP address</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - "ip address {{ ip_mask }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        parents: "interface {{ lan_interfaces[0].interface_name }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      when: lan_interfaces[0].ip_address is defined and lan_interfaces[0].ip_address | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: Changing Description</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - "description {{ lan_interfaces[0].description }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        parents: "interface {{ lan_interfaces[0].interface_name }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      when: lan_interfaces[0].description is defined and lan_interfaces[0].description | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    - name: Changing Helper Address</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      cisco.ios.ios_config:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        lines:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          - "ip helper-address {{ lan_interfaces[0].helper_address }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        parents: "interface {{ lan_interfaces[0].interface_name }}"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      when: lan_interfaces[0].helper_address is defined and lan_interfaces[0].helper_address | length &gt; 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>ios_template.j2</code> example that will convert our ACLs JSON to IOS commands:</p><div class="language-YAML codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-YAML codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#jinja2:lstrip_blocks: True</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{% for item in aces %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {#Check if source or dst IP address are IP/MASK or 'any' and set wildcard mask#}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- if item.src != 'any' -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {%- set src_wildcard = item.src | ansible.netcommon.ipaddr('wildcard') -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- if item.dst != 'any' -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {%- set dst_wildcard = item.dst | ansible.netcommon.ipaddr('wildcard') -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {##################}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {#Make initial statement (e.g.: "permit ip")#}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {{- item.action }}{{ ' ' + item.protocol -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {##################}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {#Setting src address (e.g.: "any" or "192.168.254.0 0.0.0.255")#}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- if item.src == 'any' -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {{- ' ' + item.src -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- else -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {{- ' ' + item.src | ansible.netcommon.ipaddr('network') }}{{ ' ' + src_wildcard -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {##################}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {#Setting dst address (e.g.: "any" or "192.168.254.0 0.0.0.255")#}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- if item.dst == 'any' -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {{- ' ' + item.dst -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- else -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {{- ' ' + item.dst | ansible.netcommon.ipaddr('network') }}{{ ' ' + dst_wildcard -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {##################}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {#Setting dst port (e.g.: "123" or "range 1 123"). If port contains "-" char its a range#}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- if '-' in item.port -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {% set range_initial_port, range_final_port = item.port.split('-') %}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {{- ' range ' + range_initial_port + ' ' + range_final_port -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- else -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {%- if item.protocol == 'udp' or item.protocol == 'tcp' -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">            {{- ' eq ' + item.port -}}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {%- endif -%}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {{ ' ' }}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">{% endfor %}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="storing-playbooks-templates-and-inventories">Storing playbooks, templates and inventories<a class="hash-link" href="#storing-playbooks-templates-and-inventories" title="Direct link to heading">​</a></h2><p>As stated before, we'll use gitlab to store our ansible files and use it as a source for the AWX project. AWX will query the gitlab repo and update its files (playbooks, inventories, etc.) on demand (or automatically if configured in this way). Also, please note that since this data (playbooks, inventories) have different objectives and requirements from our structured data created in the previous section you should use a separate gitlab or at least use specific permissions to allow only AWX to read this repo (not modify!) and only enable write permissions on an on-demand basis to admins/operators (eg.: update a playbook).</p><p>If you have a big automation team or several teams with different roles on IT automation you could have different gitlab repositories with different playbooks, inventories, templates, etc. and each of them only reading/modifying files on their repos. This way you minimize the permission requirements and divide risks.</p><p>You can create the repo and submit all files on gitlab using the web interface or git, or you can use the script on the full-stack automation repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>) and execute the main AWX demo script (sudo /bin/bash ./demo/awx/import_files_on_gitlab.sh)</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="configuring-awx-to-use-inventory-playbook-and-template">Configuring AWX to use inventory, playbook and template<a class="hash-link" href="#configuring-awx-to-use-inventory-playbook-and-template" title="Direct link to heading">​</a></h2><p>Now, since ansible files are on gitlab we need to configure AWX to integrate with gitlab to get the files and also create our inventory and job templates that will run our playbook (<a href="https://docs.ansible.com/ansible-tower/latest/html/userguide/job_templates.html" target="_blank" rel="noopener noreferrer">AWX job template</a> is where we link AWX to our playbook). We will also create a workflow to run our playbook because of a Ansible "limitation" on how to manipulate variables on 'import_playbook' directive.</p><p>You can do this using AWX web UI, but the <a href="https://github.com/liviozanol/full-stack_automation/blob/master/demo/awx/configure_awx.sh" target="_blank" rel="noopener noreferrer">script</a> will use AWX API, and will make the following tasks:</p><ul><li>Create a SCM credential (a gitlab deploy token) to allow AWX to login to gitlab.</li><li>Create an AWX project using our gitlab repository.</li><li>Create an inventory using our gitlab repo as a source.</li><li>Create one job template for the playbook that simply gets the network os name from inventory and stores on a variable accessible by other tasks on a workflow.</li><li>Create one job template for the playbook that implements the changes on our router (the main one that 'imports' the real playbook).</li><li>Create a job workflow to link our 2 tasks and link the 2 tasks (these are 4 APIs calls).</li></ul><p>AWX final structure shown on its web UI
<img loading="lazy" alt="AWX final structure shown on its web UI" src="/assets/images/awx-22a93ce3c67f2dd7f55a7ca2e5a5fd4c.gif" width="1200" height="756" class="img_E7b_"></p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 6 - Demo -Scenario]]></title>
        <id>full-stack-it-automation-part-6-demo-scenario</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-6-demo-scenario"/>
        <updated>2021-12-16T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Demo Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="demo-introduction">Demo Introduction<a class="hash-link" href="#demo-introduction" title="Direct link to heading">​</a></h2><p>The past 6 posts were about building the infrastructure needed to implement the full-stack automation architecture described.</p><p>From now on, we will start to build a demo scenario to use it. As stated on the first post, we will use a scenario as an example and will use the architecture to automate one service.</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="assertions">Assertions<a class="hash-link" href="#assertions" title="Direct link to heading">​</a></h4><p>Consider these information assertions about you:</p><p>You work on a network service provider that serves WAN connections to several clients.</p><p>The network topology has CPEs (routers installed on clients premises) that is connected to the provider transport network. You are required to allow clients to modify some configurations on these CPEs.</p><ul><li><p>Clients should be able to change configuration for all CPEs installed on their sites.</p></li><li><p>Clients must only modify configuration for the LAN interface of CPEs.</p></li><li><p>Clients should be able to modify configuration for interface description (?), interface IP address/subnet, interface ACLs and helper/DHCP relay address.</p></li><li><p>Clients should be able to access a web page to make modifications. They should be able to also do these actions through an API.</p></li></ul><p>Now we can begin to define our service. Let's call it "Wan Sites". You could do something similar with other services, like "DNS records", "VMs", "Containers", etc.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="structured-data">Defining Structured Data<a class="hash-link" href="#structured-data" title="Direct link to heading">​</a></h2><p>Considering the scenario described we can define a data structure that will be manipulated by users. Consider that users may view/change: ip address, description, helper address and ACLs on remote WAN sites.</p><p>We can create a structure comprehending these fields. In JSON it can be something like:</p><div class="language-JSON codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-JSON codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "site_id": "(string)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "custom_site_name": "(string)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  "lan_interfaces": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "interface_name": "(string)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "ip_address": "(ipv4/mask)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "description": "(string)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "helper_address": "(ipv4)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "in_acl": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "action": "(permit|deny)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "src": "(ipv4/mask)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "dst": "(ipv4/mask)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "protocol": "(tcp|udp|icmp|ip|gre)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "port": "(1-65535)"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ],</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      "out_acl": [</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "action": "(permit|deny)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "src": "(ipv4/mask)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "dst": "(ipv4/mask)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "protocol": "(tcp|udp|icmp|ip|gre)",</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">          "port": "(1-65535)"</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We could also start to think on more specific constraints and business rules that our service (and structured data) will have. For example:</p><ul><li>The network only supports IPv4 (for simplicity on this demo).</li><li>custom<em>site_name is a field used by the client to name its site for its own way of organizing. Must only have letters, numbers, spaces and "-" or "</em>". Should have a maximum of 20 characters.</li><li>interface_name is a string identifying the interface on the equipment (e.g.: gigabitethernet 0) and must not be edited by users.</li><li>description must only have letters, numbers, spaces and "-" or "_". Should have a maximum of 20 characters.</li><li>ip_address, acl "src" and "dst", must be expressed as ipv4 "/" mask bits (e.g.: 192.168.0.1/32).</li><li>helper_address must have only one ipv4 address (for simplicity in this demo).</li></ul><p>ACL specific constraints:</p><ul><li>action must be either "permit" or "deny".</li><li>protocol must be one of the following: tcp, udp, icmp or gre.</li><li>icmp type and code are not supported.</li><li>For protocol types ip, icmp and gre, "port" must be empty.</li><li>For protocol types tcp and udp, ports may be empty (any port), a number (e.g.: 80) or a range separated by a dash (e.g: 22-636).</li><li>Each ACL should have a maximum of 20 ACL rules/lines (aka ACEs).</li><li>src or dst IPs MUST be on interace LAN range. (e.g.: LAN=192.168.0.1/24. dst or src IP MUST be inside this range. (e.g.: 192.168.0.5/32 or 192.168.0.0/24) )</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-structure">Gitlab Structure<a class="hash-link" href="#gitlab-structure" title="Direct link to heading">​</a></h2><p>Since gitlab is being used as the place to store the data for all automated services, we must define how to use its structure to make it easy (and usable) to manipulate data for each of these. Gitlab has a feature called <a href="https://docs.gitlab.com/ee/user/group/subgroups/" target="_blank" rel="noopener noreferrer">groups and subgroups</a> that allows us to create a hierarchical tree for our projects.</p><p>Projects are the places that effectively store versioned files. In this case our structured data will be stored on these projects.</p><p>We will use the following hierarchy:</p><ul><li>For every automated service we will create a group.</li><li>For each client/tenant for each service, we will create a subgroup.</li><li>Inside every subgroup we will have projects for each service instance (e.g.: Each CPE Wan Site).</li></ul><p>Considering the above, we will have a group called "wan_sites" for our service. Any other service will have a new group (e.g.: "vms", "containers", etc.).
We will also have 2 subgroups: "client_a" and "client_b" (could be any number of subgroups. a.k.a. 'clients/tenants').
For each subgroup we will create 2 projects: site_1, site_2 (client A); site_3, site_4 (client B).
On each project we will store a file named "wan_site_cfg.json" that will store our structured JSON data detailed on the previous topic above.</p><p>So, if you want to get data from site_2, you can access the path "https://gilab_url/wan_sites/client_a/site_2/wan_site_cfg.json".</p><p>Except for project name (only in our demo), these names and paths aren't visible to the final user, so you can make your own structure and name it the way you want just adjusting your API. Example: client-&gt;service-&gt;service_instance; service-&gt;service_instance (client is a field on each instance).</p><p>Using gitlab to store this structured data have a drawback on speed and functionalities, since we are using files to store data (even that they are stored on gitlab), groups/"folders" to separate clients/services and need to make more HTTP requests to get our information. If you need more speed or a more structured way of doing this, you can use something like a database or <a href="https://netbox.readthedocs.io/en/stable/" target="_blank" rel="noopener noreferrer">Netbox</a> or Python Eve like stated before. <a href="https://docs.python-eve.org/en/stable/" target="_blank" rel="noopener noreferrer">Python Eve</a> is REALLY good for this, and you can identify resources per client on the data itself without relying on folders/groups (e.g.: a simple field called "client" on the example JSON on the previous section). It also has built-in sort and filter functions using mongodb style query.</p><p>Final gitlab structure as shown on web UI
<img loading="lazy" alt="Final gitlab structure as shown on web" src="/assets/images/gitlab-3cbffd861e235a95cae8c6ed85c97df5.gif" width="770" height="764" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="creating-gitlab-structure">Creating Gitlab Structure<a class="hash-link" href="#creating-gitlab-structure" title="Direct link to heading">​</a></h2><p>You can create the structure using the web interface, creating the wan_sites group, clients subgroups, sites projects and manually creating the a dummy wan_site_cfg.json file on each, or you can use the script on the full-stack automation repo (<a href="https://github.com/liviozanol/full-stack-automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack-automation</a>) and executing the main demo script (sudo /bin/bash ./demo/gitlab/config_gitlab.sh)</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 5 - Gitlab CI]]></title>
        <id>full-stack-it-automation-part-5-gitlabci</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-5-gitlabci"/>
        <updated>2021-12-09T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Gitlab-CI]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-ci">Gitlab-CI<a class="hash-link" href="#gitlab-ci" title="Direct link to heading">​</a></h2><p>Gitlab-CI, AKA Gitlab runner, is a Continuous Integration and Continuous Delivery/Deployment solution built by gitlab. It fully integrates with gitlab listening for changes on repositories and executing pipelines to automate build, test, approve and deploy applications.</p><p>It can run on a container and, after a change is triggered, uses docker images to execute steps configured on the pipeline.</p><p>More about Gitlab can be found on its site: <a href="https://docs.gitlab.com/ee/ci/" target="_blank" rel="noopener noreferrer">https://docs.gitlab.com/ee/ci/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-ci-role">Gitlab-CI Role<a class="hash-link" href="#gitlab-ci-role" title="Direct link to heading">​</a></h2><p>Gitlab-CI will be used as the mechanism that starts automation. It will monitor gitlab repositories, detect changes on it and call AWX to implement changes on automated resources (eg.: router). This is its main function, but it will also be used to automatically create containers needed by the API and web interface.</p><p>Gitlab-CI talks to almost every component on the solution:</p><ul><li>Calls AWX API to run and monitor jobs/playbook execution;</li><li>Monitor changes on gitlab repositories to run its CI/CD pipelines;</li><li>Create API containers and also talk to them if needed on a pipeline step (should be a separated gitlab runner);</li><li>Get keys/secrets from hashicorp vault 2 if needed on the pipeline and use them to talk to gitlab itself or to talk to full-stack automation APIs.</li></ul><p>Gitlab-CI will be running with privileged mode so it can access docker socket and create, update and delete containers on the host itself. This is needed because Gitlab-CI will be responsible for managing API and web interface containers.</p><p>For its automation function on this architecture itself gitlab-ci only needs to get data on gitlab and call AWX REST API, so no privileged mode is required and you could use something like <a href="https://hub.docker.com/_/docker" target="_blank" rel="noopener noreferrer">docker in docker</a> to run it or a direct shell script. It is a good idea to separate functions as stated before.</p><p><img loading="lazy" alt="Gitlab-CI role on architecture" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIyOTNweCIgaGVpZ2h0PSIxNTNweCIgdmlld0JveD0iLTAuNSAtMC41IDI5MyAxNTMiIGNvbnRlbnQ9IiZsdDtteGZpbGUgaG9zdD0mcXVvdDthcHAuZGlhZ3JhbXMubmV0JnF1b3Q7IG1vZGlmaWVkPSZxdW90OzIwMjEtMTItMDlUMTc6MDM6MTUuNDg3WiZxdW90OyBhZ2VudD0mcXVvdDs1LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzk2LjAuNDY2NC40NSBTYWZhcmkvNTM3LjM2JnF1b3Q7IHZlcnNpb249JnF1b3Q7MTUuOC45JnF1b3Q7IGV0YWc9JnF1b3Q7SUEyaXpKSkZjc3o0Rm5VSmV3YUwmcXVvdDsgdHlwZT0mcXVvdDtnb29nbGUmcXVvdDsmZ3Q7Jmx0O2RpYWdyYW0gaWQ9JnF1b3Q7czAzeHVTbVFDX19FVk1CZDlUTWgmcXVvdDsmZ3Q7M1ZoZGo1c3dFUHcxdkZZRzU0TThKcm5qcmxJclZZclV1M3Qwd0FHM0RvdU11WkQrK3Bxd0JITTAxN1JOZzVTWGhKMzFnbmM4WStJNGRMa3RIeFRMa3M4UWNlbDRKQ29kZXVkNDNuamttczhLMk5lQVQyWTFFQ3NSMVpEYkFpdnhneU5JRUMxRXhQUE9RQTBndGNpNllBaHB5a1Bkd1poU3NPc08yNERzUGpWak1lOEJxNURKUHZva0lwMWdGOTYweFIrNWlKUG15ZTRFKzl1eVpqQjJraWNzZ3AwRjBYdUhMaFdBcnErMjVaTExpcnVHbDdvdU9KRTlUa3p4Vko5VDROVUZyMHdXMk52OHkwZWNtdDQzL1NvbzBvaFhKYTVERjd0RWFMN0tXRmhsZDJhQkRaYm9yY1QwUmtpNUJBbnFVRXNqeHYxTmFQQmNLL2pPclF3aDB5QUlqcG1HU2NQQkFtZkZsZWJseWM3Y0kxOUdaeHkyWEt1OUdZSUYzaFFwUm8yWng5WHhybDJ4Q1VLSnRWaGp4QmhxSkQ3ZXVhWFJYQ0NUdjJhVjloamtrUkVRaGltazVtdlJra3BNQkVvbkVFUEs1Q2VBREtuOHhyWGVvL3hab2FGTE5DK0ZmcTdLUDR3eGVyRXlkeVhlK1JEc215QTFyVmhGVmZoaTU5cXlROVRVNVpvcFBhK3NZNEJRc2p3WFlRTUhRaDZubEViTklPelNJSmduRjlWR1JXaEhHVGtVS2tSb2hIc0NVekhIWmZYUDFvL2lrbW54MnIzN3Y2aGgxUFBZZzlDU3JXL0NadFNuUmtsREdXMThWYU81bHMxYTAvM1dhRjdIYWU2Zk9BMDdzRzFHdWpacnZkZzY3Ykx5ZU5kcGZ0OXBzK0djTnJudXZ2czNjbkJ0TFZpYjhBazFiQ0RWT0JIL0ZzVFIvSUliUWgzVGR6YmNTMHJoM0gxaGV2RjlZYmgxOVlaYlZ2L2s2NVVzYitPbkxQVkhuVGZzNklwdjJGbi9nSkRtWW0zbzlDYlNQR2V4VnVZcXJxN21UODgzUWZlWURIZHlhUFpIaSs5SGxpY2lCSlgxR2YvS0NvTjR4TDBKM3QrZTJQNmp6RTNZbnJFUE9ldVBDbnIvRXc9PSZsdDsvZGlhZ3JhbSZndDsmbHQ7L214ZmlsZSZndDsiPjxkZWZzLz48Zz48cmVjdCB4PSIxIiB5PSIxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjZweDsgbWFyZ2luLWxlZnQ6IDJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkFQSTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIzMSIgeT0iMzAiIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BUEk8L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMTQ0LjU4IDU5LjI0IEwgMTQ1IDEwMSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gMTQ0LjUyIDUzLjI0IEwgMTQ4LjYgNjEuMiBMIDE0NC41OCA1OS4yNCBMIDE0MC42IDYxLjI4IFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxMTQuNSIgeT0iMSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDI2cHg7IG1hcmdpbi1sZWZ0OiAxMTZweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkdpdGxhYjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNDUiIHk9IjMwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2l0bGFiPC90ZXh0Pjwvc3dpdGNoPjwvZz48cGF0aCBkPSJNIDE3NSAxMjYgTCAyNDAuMzQgNTYuOTgiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDI0NC40NiA1Mi42MiBMIDI0MS44NyA2MS4xOCBMIDI0MC4zNCA1Ni45OCBMIDIzNi4wNiA1NS42OCBaIiBmaWxsPSIjMDA3ZmZmIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHBhdGggZD0iTSAxMTUgMTI2IEwgNjkuMjQgMTI2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2My4yNCAxMjYgTCA3MS4yNCAxMjIgTCA2OS4yNCAxMjYgTCA3MS4yNCAxMzAgWiIgZmlsbD0iIzAwN2ZmZiIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxwYXRoIGQ9Ik0gMTE1IDEwMSBMIDUyLjY3IDU1LjgzIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA0Ny44MSA1Mi4zMSBMIDU2LjY0IDUzLjc3IEwgNTIuNjcgNTUuODMgTCA1MS45NCA2MC4yNSBaIiBmaWxsPSIjMDA3ZmZmIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHJlY3QgeD0iMTE1IiB5PSIxMDEiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjcuNSIgcnk9IjcuNSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxMjZweDsgbWFyZ2luLWxlZnQ6IDExNnB4OyI+PGRpdiBkYXRhLWRyYXdpby1jb2xvcnM9ImNvbG9yOiByZ2IoMCwgMCwgMCk7ICIgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyI+R2l0bGFiIENJPC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE0NSIgeT0iMTMwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2l0bGFiIENJPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIyMzEiIHk9IjEiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjcuNSIgcnk9IjcuNSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyNnB4OyBtYXJnaW4tbGVmdDogMjMycHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5BbnNpYmxlPGJyIC8+QVdYPC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjI2MSIgeT0iMzAiIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BbnNpYmxlLi4uPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIxIiB5PSIxMDEiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjcuNSIgcnk9IjcuNSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxMjZweDsgbWFyZ2luLWxlZnQ6IDJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkhhc2hpY29ycDxiciAvPlZhdWx0IDE8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzEiIHk9IjEzMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkhhc2hpY29ycC4uLjwvdGV4dD48L3N3aXRjaD48L2c+PC9nPjxzd2l0Y2g+PGcgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ii8+PGEgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwtNSkiIHhsaW5rOmhyZWY9Imh0dHBzOi8vd3d3LmRpYWdyYW1zLm5ldC9kb2MvZmFxL3N2Zy1leHBvcnQtdGV4dC1wcm9ibGVtcyIgdGFyZ2V0PSJfYmxhbmsiPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTBweCIgeD0iNTAlIiB5PSIxMDAlIj5WaWV3ZXIgZG9lcyBub3Qgc3VwcG9ydCBmdWxsIFNWRyAxLjE8L3RleHQ+PC9hPjwvc3dpdGNoPjwvc3ZnPg==" width="293" height="153" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-ci-alternatives">Gitlab-CI Alternatives<a class="hash-link" href="#gitlab-ci-alternatives" title="Direct link to heading">​</a></h2><p>You can change Gitlab-CI to other CI/CD tools very easily. It is important to note that we are using it because of its tighty integration with gitlab itself and we will be able to query the gitlab API to know which step we are in the pipeline so we can notify the user about its request.</p><p>So, feel free to use other tools like CircleCI, Jenkins, Travis, whatever.</p><p>You could also choose to not use a CI/CD as an element that starts automation. If you decide, for example, to use a solution with python EVE as a database and a MQ to talk to AWX you could have the jobs and approval steps controlled by the API directly with its status stored on python EVE and MQ could be the responsible to query AWX job status and update it on EVE.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-ce-install-config">Gitlab-CI Installation and Configuration<a class="hash-link" href="#gitlab-ce-install-config" title="Direct link to heading">​</a></h2><p>First, if you haven't cloned the architecture repo from github, please do so: <code>git clone https://github.com/liviozanol/full-stack-automation</code></p><p>TL;DR: Simply run the shell script</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sudo</span><span class="token plain"> /bin/bash installation/gitlab-runner/create_gitlabrunner.sh</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You need to have docker available. Docker service must be running and healthy (check with <code>sudo docker ps</code> or similar).</p></div></div><p>Installing gitlab-runner is simple as issuing a docker run</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo docker run -d --name gitlab-runner --restart always \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    --privileged \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -v /var/run/docker.sock:/var/run/docker.sock \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    -v /srv/gitlab-runner:/etc/gitlab-runner:Z \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    gitlab/gitlab-runner:alpine</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the next steps, gitlab-runner will be configured to register on gitlab and monitor changes.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="gitops" term="gitops"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 4 - AWX]]></title>
        <id>full-stack-it-automation-part-4-awx</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-4-awx"/>
        <updated>2021-12-08T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Ansible/AWX]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="ansible-awx">Ansible/AWX<a class="hash-link" href="#ansible-awx" title="Direct link to heading">​</a></h2><p>Ansible is an automation platform that supports a wide range of functions and can be used to automate almost anything: From network devices from different manufacturers to custom web APIs. The choice for ansible in this layer is for this reason and also because of AWX.</p><p>AWX is a complete automation solution based on ansible. It boosts ansible adding a lot of functionalities to make a complete automation tool mainly introducing a nice web system. Some cool functionalities includes:</p><ul><li>A web interface where you can make all life-cycle related activities with playbooks (monitor, execute, cancel, group, etc.). You still create the playbooks external.</li><li>Workflow of playbooks where you can execute one or more playbooks in sequence giving certain circumstances and even insert approval tasks!</li><li>Nice web forms with basic data validation to start playbooks execution.</li><li>Notification of jobs status using e-mail, telegram, rocketchat, etc.</li><li>Integration with git or other sources to read inventories and playbooks.</li><li>LDAP and other integrations to authentication/authorization.</li><li>And more important: A complete REST API that gives access to all of the above and more!</li></ul><p>Note that AWX comes with a form to play tasks/playbooks that could be used for more simple automations. If you have small tight teams to OAMP only some infrastructure you could use it directly. But secrets for automated resources could be leaked and I do not think that this is a good solution for end-user direct intervention. So do it at your own risk.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>To execute any playbook you can (and <em>really</em> should) add a bastion host to access your automated elements, and make AWX use, for example, SSH tunnel prior to connecting to the automated element, protecting it even more from undesirable access. <a href="https://docs.ansible.com/ansible/5/reference_appendices/faq.html#how-do-i-configure-a-jump-host-to-access-servers-that-i-have-no-direct-access-to" target="_blank" rel="noopener noreferrer">Read more on ansible documentation.</a>.</p></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ansible-role">Ansible/AWX Role<a class="hash-link" href="#ansible-role" title="Direct link to heading">​</a></h2><p>Ansible/AWX is the "engine" that will access automation elements and execute actions to implement the changes submitted by the user (i.e. run a playbook) and validated by API and CI/CD.</p><ul><li>It talks to any automated resource to execute change actions.</li><li>It talks to hashicorp vault 1 to get keys/pass to access the automated resources</li><li>It talks to gitlab to get inventories, playbooks and complementary files (templates, etc.).</li><li>It receives API requests from Gitlab CI to start and monitor jobs/playbooks.</li></ul><p>Even if AWX has an approval task on workflows, the solution described here won't use it. Since AWX has access to sensitive data, like key or pass to access infrastructure resources, we need to minimize any human intervention on it and also its point of contact with other infrastructure. Only gitlab CI/CD will talk actively to AWX on full-stack automation architecture. AWX solution will be used solely as a way to start and monitor tasks execution.</p><p><img loading="lazy" alt="AWX/ansible role on architecture" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIzMTlweCIgaGVpZ2h0PSIyNDNweCIgdmlld0JveD0iLTAuNSAtMC41IDMxOSAyNDMiIGNvbnRlbnQ9IiZsdDtteGZpbGUgaG9zdD0mcXVvdDthcHAuZGlhZ3JhbXMubmV0JnF1b3Q7IG1vZGlmaWVkPSZxdW90OzIwMjEtMTItMDlUMTY6MzM6NDcuMTkxWiZxdW90OyBhZ2VudD0mcXVvdDs1LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzk2LjAuNDY2NC40NSBTYWZhcmkvNTM3LjM2JnF1b3Q7IHZlcnNpb249JnF1b3Q7MTUuOC45JnF1b3Q7IGV0YWc9JnF1b3Q7dHR3ejUwSkZtNDhQRVJ2TEN4RnImcXVvdDsgdHlwZT0mcXVvdDtnb29nbGUmcXVvdDsmZ3Q7Jmx0O2RpYWdyYW0gaWQ9JnF1b3Q7UDhPbTZ6Ri1sRzJzMG1aOVJhZG8mcXVvdDsmZ3Q7NVZqYmp0b3dFUDBhcFBhaHExd0loRWRnbDkxSzdVdVJ1dkJva2lGeGF6S3A0eXloWDE4bkdaT2tXZFR0UmFDbEwrQTU0N0V6Wjg0NGw0RTczeFgza3FYeFJ3eEJEQndyTEFidTdjQnh2S0d0ZjB2Z1VBTytOYW1CU1BLd2h1d0dXUEx2UUtCRmFNNUR5RG9URmFKUVBPMkNBU1lKQktxRE1TbHgzNTIyUmRIZE5XVVI5SUJsd0VRZmZlU2hpaWtMWjl6Z0Q4Q2oyT3hzanlpL0hUT1RLWk1zWmlIdVc1QjdOM0RuRWxIVm8xMHhCMUZ5WjNpcDR4WW52TWNMazVDb2x3UTRkY0FURXpubGRzK1ZZQnU2T25Vd0tVdk1reERLS0h2Z3p2WXhWN0JNV1ZCNjk3ckdHb3ZWVHBCN3k0V1lvMEJaeGJvaEEzOGJhRHhURXI5Q3kyTlo0OFZpY2ZRWU1qVU5NN293a0FxS2s4blpSOHEwMUFCM29PUkJUNkVBMTNkdnZEcUloS1kzck8xOVU3WVJRWEdyWWg1aGpJUVNIZGR1dU5RRG92TjVhdDBlaHhCcUZaR1pZS0wvWmcydGxyWlFxaGdqVEpqNGdKZ1NtVjlBcVFQMUFNc1ZkcW1HZ3F0VmE3d3VsOUpaMTladFFTdFh4c0VZaVU1bFZVMTBQR092elNLbDBjUlZsZ25NRkpOcVdqWlFrMEdGTFhoSkEwV0Vaa1lnV0pieG9BWnB5citWUjhsb1J4d1o1aklnYUVnbkE1TVJVRjM5RjB0SWdtQ0tQM1ZYL3hzNURFOTJtalYvZnlYdE51dzAyL0NNemVhZHRkbWFCbHUzKyt0WHpYYkZ2ZWIzZTIxeXVWNGJ2WUtqdDYyRmxqU3VWUTNtMGUwU2NoaWY5M0Q0RXpuWS81a2NuTXVwd2UvZGlLZEp4amRhQzg1STZHdVpiYVFlUmVWbytyaTZpanV6Wis3RUYzZ01udlRvZm1CWnpBT1VhWi93enl6WGlHTTVWMG43OFJBOEErMW1xN2JNOVpHbFgwQTFpVDNlUHdIMWE4OWprQzBtcWxPUjBiY2NqZU5kVmgyS1V6M0JUNHZHWnhaNUE5Rk4yY3FZSzVCdnpaSTZoWHBWczlQSmtsdXZwdVFqNTZlU1Q4Ym1GYlJWZFArNW9udS9YWFJ0Tmw4S0tsL3JjNHQ3OXdNPSZsdDsvZGlhZ3JhbSZndDsmbHQ7L214ZmlsZSZndDsiPjxkZWZzLz48Zz48cmVjdCB4PSIwLjUiIHk9IjkxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMTE2cHg7IG1hcmdpbi1sZWZ0OiAycHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5HaXRsYWI8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzEiIHk9IjEyMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdpdGxhYjwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSA2MSAyMTYgTCAxMjYuMzQgMTQ2Ljk4IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxMzAuNDYgMTQyLjYyIEwgMTI3Ljg3IDE1MS4xOCBMIDEyNi4zNCAxNDYuOTggTCAxMjIuMDYgMTQ1LjY4IFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxIiB5PSIxOTEiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjcuNSIgcnk9IjcuNSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyMTZweDsgbWFyZ2luLWxlZnQ6IDJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkdpdGxhYiBDSTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIzMSIgeT0iMjIwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2l0bGFiIENJPC90ZXh0Pjwvc3dpdGNoPjwvZz48cGF0aCBkPSJNIDE0NyA5MSBMIDE0NyA1OS4yNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gMTQ3IDUzLjI0IEwgMTUxIDYxLjI0IEwgMTQ3IDU5LjI0IEwgMTQzIDYxLjI0IFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDE3NyAxMTYgTCAyMjguNzYgMTE2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAyMzQuNzYgMTE2IEwgMjI2Ljc2IDEyMCBMIDIyOC43NiAxMTYgTCAyMjYuNzYgMTEyIFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cGF0aCBkPSJNIDExNyAxMTYgTCA2OC43NCAxMTYiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDYyLjc0IDExNiBMIDcwLjc0IDExMiBMIDY4Ljc0IDExNiBMIDcwLjc0IDEyMCBaIiBmaWxsPSIjMDA3ZmZmIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHJlY3QgeD0iMTE3IiB5PSI5MSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDExNnB4OyBtYXJnaW4tbGVmdDogMTE4cHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5BbnNpYmxlPGJyIC8+QVdYPC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjE0NyIgeT0iMTIwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QW5zaWJsZS4uLjwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMTE3IiB5PSIxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjZweDsgbWFyZ2luLWxlZnQ6IDExOHB4OyI+PGRpdiBkYXRhLWRyYXdpby1jb2xvcnM9ImNvbG9yOiByZ2IoMCwgMCwgMCk7ICIgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyI+SGFzaGljb3JwPGJyIC8+VmF1bHQgMjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNDciIHk9IjMwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SGFzaGljb3JwLi4uPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIyMzciIHk9Ijg4LjUiIHdpZHRoPSI4MCIgaGVpZ2h0PSI1NSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNzhweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAxMTZweDsgbWFyZ2luLWxlZnQ6IDIzOHB4OyI+PGRpdiBkYXRhLWRyYXdpby1jb2xvcnM9ImNvbG9yOiByZ2IoMCwgMCwgMCk7ICIgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyI+QXV0b21hdGVkPGJyIC8+UmVzb3VyY2U8YnIgLz48Zm9udCBzdHlsZT0iZm9udC1zaXplOiA4cHgiPihlZy4gcm91dGVyKTwvZm9udD48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMjc3IiB5PSIxMjAiIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BdXRvbWF0ZWQuLi48L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=" width="319" height="243" class="img_E7b_"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ansible-alternatives">Ansible/AWX Alternatives<a class="hash-link" href="#ansible-alternatives" title="Direct link to heading">​</a></h2><p>You can use other automation tools you like, but since the solution is using AWX as an API to execute and monitor jobs, it's important that you execute it using ansible playbooks. Since ansible can execute any arbitrary shell and python command (and others if you install it), you can use <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">terraform</a>, <a href="https://nornir.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">nornir</a>, <a href="https://napalm.readthedocs.io/en/latest/" target="_blank" rel="noopener noreferrer">napalm</a>, <a href="https://en.wikipedia.org/wiki/Expect" target="_blank" rel="noopener noreferrer">expect</a>, custom scripts, whatever, but it needs to be called from ansible. You can, for example, install custom linux packages on ansible job execution containers and just call a shell script in a playbook.</p><p>Yes, ansible can be <a href="https://networklore.com/ansible-nornir-speed/" target="_blank" rel="noopener noreferrer">slow in some situations</a>, and templates or <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html" target="_blank" rel="noopener noreferrer">jinja2</a> like language sometimes are too much complex and boring to write, but for this architecture, objetiving a manufacturer agnostic and wide range automation, its important. If you need high speeds or don't like ansible at all, you can use your preferred automation tool through ansible as explained, or just build a new API for you custom automation tool - if it doesn't have (and insert a MQ solution as stated on gitlab session).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="ansible-install-config">Ansible/AWX Installation and Configuration<a class="hash-link" href="#ansible-install-config" title="Direct link to heading">​</a></h2><p>First, if you haven't cloned the architecture repo from github, please do so: <code>git clone https://github.com/liviozanol/full-stack_automation</code></p><p>TL;DR: Simply run the shell script</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo /bin/bash installation/awx/create_awx.sh</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this guide AWX/ansible will be installed using docker-compose (which is not indicated for production - should be kubernetes instead). Will be used the <a href="https://github.com/ansible/awx/blob/devel/tools/docker-compose/README.md" target="_blank" rel="noopener noreferrer">"official" awx docker-compose guide</a>.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You need to have jq (used by script), ansible, openssl, docker and docker-compose available. Docker service must be running and healthy (check with <code>sudo docker ps</code> or similar).</p><p>As of 2021-12-07, you also need to be able to execute <code>make</code> (i.e.: build-essential, make, automake, gcc, etc.).</p><p>The steps below are already done by the script, which also makes some bugfixes. They are here only for information.</p></div></div><p>1- Clone AWX Repo (version 19.5.0)</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">git</span><span class="token plain"> clone -b </span><span class="token number">19.5</span><span class="token plain">.0 https://github.com/ansible/awx.git</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>2- CD to the directory</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> awx</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>3- Change passwords/secrets</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">sed</span><span class="token plain"> -i </span><span class="token string" style="color:rgb(255, 121, 198)">'s/# pg_password=""/pg_password="fullstack_automation_pg"/g;s/# broadcast_websocket_secret=""/broadcast_websocket_secret="fullstack_automation_broadcast_websocket"/g;s/# secret_key=""/secret_key="fullstack_automation_secret"/g'</span><span class="token plain"> tools/docker-compose/inventory</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>4- Build the image</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> docker-compose-build</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>5- Run AWX</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> </span><span class="token function" style="color:rgb(80, 250, 123)">docker-compose</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">COMPOSE_UP_OPTS</span><span class="token operator">=</span><span class="token plain">-d</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>6- Enable WEB UI (not required but good for troubleshooting)</p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Please wait about 5 minutes so AWX is up and running before issuing this command</p></div></div><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> tools_awx_1 </span><span class="token function" style="color:rgb(80, 250, 123)">make</span><span class="token plain"> clean-ui ui-devel</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>7- Change default admin password</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">docker</span><span class="token plain"> </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">exec</span><span class="token plain"> -it tools_awx_1 </span><span class="token function" style="color:rgb(80, 250, 123)">bash</span><span class="token plain"> -c </span><span class="token string" style="color:rgb(255, 121, 198)">"awx-manage update_password --username=admin --password=awx-fullstackautomationpass"</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><hr><p>Below steps can also be done using AWX web UI, but for simplicity, everything will be done using its REST API.</p><p>8- Create an organization that will be used to further commands</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AWX_ORG_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -sk --request POST https://admin:awx-fullstackautomationpass@localhost:8043/api/v2/organizations/ -H </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/json"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --data </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{"description": "full stack organization", "name": "FULLSTACK_INC"}'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq .id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">"Adding Default Galaxy Credential to Organization. (Needed to install custom collections from ansible galaxy)"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -sk --request POST https://admin:awx-fullstackautomationpass@localhost:8043/api/v2/organizations/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$AWX_ORG_ID</span><span class="token plain">/galaxy_credentials/ -H </span><span class="token string" style="color:rgb(255, 121, 198)">"Content-Type: application/json"</span><span class="token plain"> --data </span><span class="token string" style="color:rgb(255, 121, 198)">'{"id": 2}'</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> jq .id</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>9- Create a user that will be used by GITLAB-CI to start and monitor jobs/playbooks</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AWX_USER_ID</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -sk --request POST https://admin:awx-fullstackautomationpass@localhost:8043/api/v2/organizations/$AWX_ORG_ID/users/ -H </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/json"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --data </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{"email": "user@fullstackapi.io", "first_name": "fullstack", "is_superuser": false, "last_name": "api", "password": "fullstackapi_pass", "username": "fullstackapi" }'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq .id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>10- Create a credential type to store harshicorp vault token so it can be used later to request secrets. You could try to use the specific harshicorp vault credential type that AWX already has, but we'll be using a custom one</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AWX_VAULT_CREDENTIAL_TYPE</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -sk --request POST https://admin:awx-fullstackautomationpass@localhost:8043/api/v2/credential_types/ -H </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/json"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --data </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">'{"name": "Custom Vault Cred Type","description": "Custom credential type to store vault token","kind": "cloud","inputs": { "fields": [ {"id": "vault_server","type": "string","label": "URL to Vault Server (i.e: http://127.0.0.1:5555/)" },{ "id": "vault_token","type": "string","label": "Vault token","secret": true}],"required": ["vault_server","vault_token"]},"injectors": { "extra_vars": { "vault_server": "{{ vault_server }}",   "vault_token": "{{ vault_token }}"}}}'</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq .id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>11- Create a credential to store vault token and url, using the credential type just created</p><div class="language-shell codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-shell codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">AWX_VAULT_CREDENTIAL</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><span class="token variable function" style="color:rgb(80, 250, 123);font-style:italic">curl</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> -sk --request POST https://admin:awx-fullstackautomationpass@localhost:8043/api/v2/organizations/$AWX_ORG_ID/credentials/ -H </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"Content-Type: application/json"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> --data </span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">"{</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">credential_type</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">: </span><span class="token variable string variable" style="color:rgb(189, 147, 249);font-style:italic">$AWX_VAULT_CREDENTIAL_TYPE</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">,</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">description</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">: </span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">vault credential</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">, </span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">inputs</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">:{</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">vault_server</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">:</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">http://127.0.0.1:9200</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">,</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">vault_token</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">:</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">fullstackautomation-root-token-vault2</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">}, </span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">name</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">: </span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">vault_credential</span><span class="token variable string entity" style="color:rgb(255, 121, 198);font-style:italic">\"</span><span class="token variable string" style="color:rgb(255, 121, 198);font-style:italic">}"</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> </span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">|</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic"> jq .id</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">`</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Everything is set to use AWX in the architecture. On further steps, after we create our repos on gitlab, we'll be creating projects, inventories and templates. All linked to the gitlab source.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="terraform" term="terraform"/>
        <category label="playbook" term="playbook"/>
        <category label="inventory" term="inventory"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 3 - Vault]]></title>
        <id>full-stack-it-automation-part-3-Vault</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-3-Vault"/>
        <updated>2021-12-07T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Harshicorp Vault]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="harshicorp-vault">Harshicorp Vault<a class="hash-link" href="#harshicorp-vault" title="Direct link to heading">​</a></h2><p><a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Harshicorp Vault</a> is a solution to secure store and get sensitive information. It has a lot of features, like One Time Password, many auth methods, policies, temp tokens, etc.</p><p>For this solution will be used a basic auth with token (no refreshment) to query vault, simple Key/Value will store keys/passwords. Of course it can and should be improved, like using policies, temp tokens, other auth methods, lease duration, etc. You can (and should) also limit requests for secrets based on IP addresses.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vault-role">Harshicorp Vault<a class="hash-link" href="#vault-role" title="Direct link to heading">​</a></h2><p>The full-stack automation solution will have 2 vaults.</p><p><img loading="lazy" alt="Vault role on architecture" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIyOTNweCIgaGVpZ2h0PSIyNDNweCIgdmlld0JveD0iLTAuNSAtMC41IDI5MyAyNDMiIGNvbnRlbnQ9IiZsdDtteGZpbGUgaG9zdD0mcXVvdDthcHAuZGlhZ3JhbXMubmV0JnF1b3Q7IG1vZGlmaWVkPSZxdW90OzIwMjEtMTItMDlUMTY6NTI6NTAuOTU1WiZxdW90OyBhZ2VudD0mcXVvdDs1LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzk2LjAuNDY2NC40NSBTYWZhcmkvNTM3LjM2JnF1b3Q7IHZlcnNpb249JnF1b3Q7MTUuOC45JnF1b3Q7IGV0YWc9JnF1b3Q7SGVsVENFbUhhYktmQzVScnBIYjMmcXVvdDsgdHlwZT0mcXVvdDtnb29nbGUmcXVvdDsmZ3Q7Jmx0O2RpYWdyYW0gaWQ9JnF1b3Q7cVFYX0tHbFMwUUZkNUtLRlJXaDYmcXVvdDsmZ3Q7M1ZqYmJ1SXdFUDBhWGxlNWNBbVBRRXU3MHE2MEV0SzJmVFNKU2R5YVRPUTRFUGJyZDVKTWJuVlJ1emZRNWdVOHh4N0hQajVuWWhpNXEzMStwMWdTZllXQXk1RmpCZm5JdlJrNXptUnM0MmNCbkNyQXMrWVZFQ29SVkpEZEFodnhneE5vRVpxSmdLZTlnUnBBYXBIMFFSL2ltUHU2aHpHbDROZ2Z0Z1BaZjJyQ1FtNEFHNTlKRTMwUWdZNW9GODZzeGUrNUNLUDZ5ZmFVOXJkbjlXRGFTUnF4QUk0ZHlMMGR1U3NGb0t2V1BsOXhXWEJYODFMbHJjLzBOZ3RUUE5ZZlNYQm9HZnBVNzQwSHVGVUtZNGp4YTZrZ2l3TmVaRmdZZ2RJUmhCQXorUVVnUWRCRzhKbHJmYUtEWXBrR2hDSzlsOVRMYzZFZmkvUlBFNHFlT2owM09jMWNCcWM2aUxVNmRaS0s4S25iMTZhVlVaMjNnMWpUUWp3TVU4MlVYaFJuM3U2bnhOWkN5bWFDb0I3aFM1YW13cTlBR2xLc2M0Zk5GVWhRSlVsdXdMaTM4OHVwRkx6d1RvOWx6ZGJyZGROVHl3TVBkbGxSWGZEYk82d1VNdVVUNUpLWW1RcDVMUjdMUEZPN1VRbzZqTU9lSXdFNFJISEp0RGowcDJlazliQVoxOG9CRzZTSXQ5VkJ5emt3bWRHa2kyK2ZEY1cwOGlpWU9rWkM4MDNDeWkwZDBmNTlLZnc5SWc5Y2FaNmYxZjBaamlqQm1SR3RWSUh3Y1ZWOGJQMDhKU2pxV0hsaS9UbXI0NHQ2enU0NHJ2WGZ1NTV6ZXFhejN6SGQvK1d5cWVreTczb21tMXkyQlArT0hPeXVGanIxZUlnbCtBMXhYTE1FVDQwU2ZDZTBaRnZFVnNNb3hhNDM3cFhpOFFWTDhleUsxeC9yWTk1N2RmMFpWaVgyVExQTnIrYzF6N3p1eEtuWW9oYWNxY1MxTExjS1cySFJXanc4RHNKOEUrdDY5NkM1UWZjOVN5UGhnMHBNd3IrekRCSEhNbit3RElIMjVoVnpBZHJyUi8wYTcvWWdlSDk5N2YrSDd4b00yNS94WlYvbnZ4RDM5aWM9Jmx0Oy9kaWFncmFtJmd0OyZsdDsvbXhmaWxlJmd0OyI+PGRlZnMvPjxnPjxwYXRoIGQ9Ik0gMzEgMTQxIEwgMzEgMTgyLjc2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAzMSAxODguNzYgTCAyNyAxODAuNzYgTCAzMSAxODIuNzYgTCAzNSAxODAuNzYgWiIgZmlsbD0iIzAwN2ZmZiIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjEiIHk9IjkxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMTE2cHg7IG1hcmdpbi1sZWZ0OiAycHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5BUEk8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzEiIHk9IjEyMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkFQSTwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAxNzUgMjE2IEwgMjQwLjM0IDE0Ni45OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gMjQ0LjQ2IDE0Mi42MiBMIDI0MS44NyAxNTEuMTggTCAyNDAuMzQgMTQ2Ljk4IEwgMjM2LjA2IDE0NS42OCBaIiBmaWxsPSIjMDA3ZmZmIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHBhdGggZD0iTSAxMTUgMjE2IEwgNjkuMjQgMjE2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA2My4yNCAyMTYgTCA3MS4yNCAyMTIgTCA2OS4yNCAyMTYgTCA3MS4yNCAyMjAgWiIgZmlsbD0iIzAwN2ZmZiIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjExNSIgeT0iMTkxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjE2cHg7IG1hcmdpbi1sZWZ0OiAxMTZweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkdpdGxhYiBDSTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNDUiIHk9IjIyMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkdpdGxhYiBDSTwvdGV4dD48L3N3aXRjaD48L2c+PHBhdGggZD0iTSAyNjEgOTEgTCAyNjEgNTkuMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJzdHJva2UiLz48cGF0aCBkPSJNIDI2MSA1My4yNCBMIDI2NSA2MS4yNCBMIDI2MSA1OS4yNCBMIDI1NyA2MS4yNCBaIiBmaWxsPSIjMDA3ZmZmIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHJlY3QgeD0iMjMxIiB5PSI5MSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDExNnB4OyBtYXJnaW4tbGVmdDogMjMycHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5BbnNpYmxlPGJyIC8+QVdYPC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9IjI2MSIgeT0iMTIwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QW5zaWJsZS4uLjwvdGV4dD48L3N3aXRjaD48L2c+PHJlY3QgeD0iMjMxIiB5PSIxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjZweDsgbWFyZ2luLWxlZnQ6IDIzMnB4OyI+PGRpdiBkYXRhLWRyYXdpby1jb2xvcnM9ImNvbG9yOiByZ2IoMCwgMCwgMCk7ICIgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7Ij48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IGFsbDsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyI+SGFzaGljb3JwPGJyIC8+VmF1bHQgMjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIyNjEiIHk9IjMwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+SGFzaGljb3JwLi4uPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIxIiB5PSIxOTEiIHdpZHRoPSI2MCIgaGVpZ2h0PSI1MCIgcng9IjcuNSIgcnk9IjcuNSIgZmlsbD0iI2RhZThmYyIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiIHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogNThweDsgaGVpZ2h0OiAxcHg7IHBhZGRpbmctdG9wOiAyMTZweDsgbWFyZ2luLWxlZnQ6IDJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkhhc2hpY29ycDxiciAvPlZhdWx0IDE8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMzEiIHk9IjIyMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkhhc2hpY29ycC4uLjwvdGV4dD48L3N3aXRjaD48L2c+PC9nPjxzd2l0Y2g+PGcgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5Ii8+PGEgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCwtNSkiIHhsaW5rOmhyZWY9Imh0dHBzOi8vd3d3LmRpYWdyYW1zLm5ldC9kb2MvZmFxL3N2Zy1leHBvcnQtdGV4dC1wcm9ibGVtcyIgdGFyZ2V0PSJfYmxhbmsiPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTBweCIgeD0iNTAlIiB5PSIxMDAlIj5WaWV3ZXIgZG9lcyBub3Qgc3VwcG9ydCBmdWxsIFNWRyAxLjE8L3RleHQ+PC9hPjwvc3dpdGNoPjwvc3ZnPg==" width="293" height="243" class="img_E7b_"></p><p>Vault 1 only stores secret keys/values that will be used by AWX which are secrets that have access to modify infrastructure resources (e.g. router user/pass). A much more sensitive information.</p><p>Vault 2 stores secret keys/values to be used by the APIs, gitlab CI and AWX. It stores AWX user/pass and gitlab token. APIs need access to read/write on repositories of gitlab to change our structured data and will use the token stored on Vault for this. Gitlab-CI/Runner needs to start and read jobs on AWX using its API and will use user/pass stored on Vault for this.</p><p>Considering the sensitive data, vault 1 MUST only be accessed by AWX, and should preferably be installed in a specific network/security segment with ACLs/firewall rules permitting only AWX communication. This vault should only store credentials that will be used by the automation engine (ansible/awx).</p><p>Also, rules can be used inside Vault that permits reading key/pass only by AWX (IP based). In this way, even if the access token from AWX is leaked and even if for some reason an attacker can communicate with Vault, it won't be able to get the sensitive key/pass.</p><p>On the "demo" solution, for simplicity, the 2 vaults will be on the same host, but in a production environment must be separated. Also, will be used the "dev" mode with local file storage and no TLS, but in a production environment you must, of course, install it with TLS.</p><p>Also, on demo, Vault 2 will store user credentials (user/pass) that are used by end users to query API and also used on the UI for authentication. On production, you should consider using other authentication/authorization method for them.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vault-alternatives">Harshicorp Vault Alternatives<a class="hash-link" href="#vault-alternatives" title="Direct link to heading">​</a></h2><p>You can use other methods or solutions if wanted like: gitlab secret variables; ansible/awx own vault; azure/aws vault; whatever. Harshicorp vault is used because it's a great software, with nice API, has enhanced security and is cloud/architecture agnostic. Also it has only one separate function in the solution, so, if needed, it can be easily changeable.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="vault-install-config">Harshicorp Vault Installation and Configuration<a class="hash-link" href="#vault-install-config" title="Direct link to heading">​</a></h2><p>First, if you haven't cloned the architecture repo from github, please do so: <code>git clone https://github.com/liviozanol/full-stack-automation</code></p><p>TL;DR: Simply run the shell script</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo /bin/bash installation/vault/create_vaults.sh</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this guide Harshicorp Vault will be installed using docker-compose.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You need to have docker and docker-compose available. Docker service must be running and healthy (check with <code>sudo docker ps</code> or similar).</p></div></div><p>The installation has a docker-compose YAML and a shell script. The shell script is used to create the key/pass on the 2 vaults that will be used to authenticate on AWX, gitlab and on the automated element. Note that vault is running only on HTTP. In a production environment you should run it on HTTPS (offloaded or not).</p><p>The docker-compose will install and run vault.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="harshicorp vault" term="harshicorp vault"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 2 - Gitlab]]></title>
        <id>full-stack-it-automation-part-2-gitlab</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-2-gitlab"/>
        <updated>2021-12-04T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Gitlab]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab">Gitlab<a class="hash-link" href="#gitlab" title="Direct link to heading">​</a></h2><p>Since gitlab is the center of our architecture we'll start by installing and configuring it.</p><p>Gitlab is a git source code controller with a nice websystem that doesn't need introductions and is very similar to github. It has versioning, issues control, tags, auto devops, and a lot of features that you can explore.</p><p>More about Gitlab can be found on its site: <a href="https://about.gitlab.com/stages-devops-lifecycle" target="_blank" rel="noopener noreferrer">https://about.gitlab.com/stages-devops-lifecycle</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-role">Gitlab Role<a class="hash-link" href="#gitlab-role" title="Direct link to heading">​</a></h2><p><img loading="lazy" alt="Gitlab role on architecture" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSIyOTJweCIgaGVpZ2h0PSIxNTJweCIgdmlld0JveD0iLTAuNSAtMC41IDI5MiAxNTIiIGNvbnRlbnQ9IiZsdDtteGZpbGUgaG9zdD0mcXVvdDthcHAuZGlhZ3JhbXMubmV0JnF1b3Q7IG1vZGlmaWVkPSZxdW90OzIwMjEtMTItMDZUMTk6MjM6NTYuODI2WiZxdW90OyBhZ2VudD0mcXVvdDs1LjAgKFdpbmRvd3MgTlQgMTAuMDsgV2luNjQ7IHg2NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzk2LjAuNDY2NC40NSBTYWZhcmkvNTM3LjM2JnF1b3Q7IHZlcnNpb249JnF1b3Q7MTUuOC45JnF1b3Q7IGV0YWc9JnF1b3Q7NFRHOXZmZEROSUd3NnVkNlJ6T2YmcXVvdDsgdHlwZT0mcXVvdDtnb29nbGUmcXVvdDsmZ3Q7Jmx0O2RpYWdyYW0gaWQ9JnF1b3Q7WUM5ODVNZTJHczBLOVFWd095ckEmcXVvdDsmZ3Q7M1ZmQmpwc3dFUDBhcmlzQ2dkQmprbDIybFZxcFVnNmJIQjJZZ0Z2RFJNWUowSyt2QVJQanBXbFhiY1JXdWV4NjNzell6RHkva1dPNTY2eDY1dVNZZnNFWW1PWFljV1c1ajVianpIMWIvbTJBdWdNV250TUJDYWR4QjgwMHNLRS9RSUVxTHpuUkdBb2pVQ0F5UVk4bUdHR2VReVFNakhDT3BSbDJRR2FlZWlRSmpJQk5STmdZZmFHeFNEczBjQllhL3dnMFNmdVRaLzZIenBPUlBsaFZVcVFreG5JQXVVK1d1K2FJb2x0bDFScFkwN3UrTDExZWVNVjcrVEFPdVhoTGd1cDdJZXErTm9obHFjck1NWmYvVmh4UGVReE5oaTB0NUNMRkJIUENQaU1lSlRpVDREY1FvbFpFa1pOQUNhVWlZOG9MRlJYYndYclhiUFhnS2V1eFVqdTNSdDBidWVEMWRtZ01zaHBUcDdWV24xY0l3c1d5SVZrWDBHSWhaVXpGSE9SeWpReDVXN0liRXdnT1VSdkg4VHNNUExhOUNNUHc0dW5KbGpTdHVzWTEzVEphWCtDSlJ3cHkxZFVrUEFIRmhqY21hSGFoWGNvRk1BTlpqUXpod0lpZ1ozTjNvaTV1Y29uVDNNcUZvdmZYVkt1dk9STjJVcHN1djM0YTBhKzVic2dxVXlwZ2N5UnRSYVhVc3NucjdmcDRCaTZndW5xSnIvUklKVGdMcFNZMVR1UnhuVjFxY2ZZakp4M28wclAvdmF2elNRV2tSYk1iZVA0a0lLMlpuU0daTndnb1lxUW9hUFJLUSszQmVmeEtaUktaWG1QZVdHUCsrMm5NRzJuc21RcEc5bmNoTXpkd0g3eDNFNXAvdGJYMitqN0dtQnZNamU3T0orenVZdG94OWpmdmdObnQzd0dER2FZSG5SNWp0NzBidngxandYLzFWQWpHVDRXOG9IdDVGeHlmeVc5WjdibGNKYzFxK2JLOUMvRjU5bVJ2Q0ducUIzN3JHL3hLY3A5K0FnPT0mbHQ7L2RpYWdyYW0mZ3Q7Jmx0Oy9teGZpbGUmZ3Q7Ij48ZGVmcy8+PGc+PHBhdGggZD0iTSA2MSAyNiBMIDEwNi4yNiAyNiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gMTEyLjI2IDI2IEwgMTA0LjI2IDMwIEwgMTA2LjI2IDI2IEwgMTA0LjI2IDIyIFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxIiB5PSIxIiB3aWR0aD0iNjAiIGhlaWdodD0iNTAiIHJ4PSI3LjUiIHJ5PSI3LjUiIGZpbGw9IiNkYWU4ZmMiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTAuNSAtMC41KSI+PHN3aXRjaD48Zm9yZWlnbk9iamVjdCBwb2ludGVyLWV2ZW50cz0ibm9uZSIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgcmVxdWlyZWRGZWF0dXJlcz0iaHR0cDovL3d3dy53My5vcmcvVFIvU1ZHMTEvZmVhdHVyZSNFeHRlbnNpYmlsaXR5IiBzdHlsZT0ib3ZlcmZsb3c6IHZpc2libGU7IHRleHQtYWxpZ246IGxlZnQ7Ij48ZGl2IHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hodG1sIiBzdHlsZT0iZGlzcGxheTogZmxleDsgYWxpZ24taXRlbXM6IHVuc2FmZSBjZW50ZXI7IGp1c3RpZnktY29udGVudDogdW5zYWZlIGNlbnRlcjsgd2lkdGg6IDU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjZweDsgbWFyZ2luLWxlZnQ6IDJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkFQSTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIzMSIgeT0iMzAiIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BUEk8L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMTQ0LjU4IDU5LjI0IEwgMTQ1IDEwMSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxwYXRoIGQ9Ik0gMTQ0LjUyIDUzLjI0IEwgMTQ4LjYgNjEuMiBMIDE0NC41OCA1OS4yNCBMIDE0MC42IDYxLjI4IFoiIGZpbGw9IiMwMDdmZmYiIHN0cm9rZT0iIzAwN2ZmZiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJhbGwiLz48cmVjdCB4PSIxMTQuNSIgeT0iMSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDI2cHg7IG1hcmdpbi1sZWZ0OiAxMTZweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkdpdGxhYjwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSIxNDUiIHk9IjMwIiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R2l0bGFiPC90ZXh0Pjwvc3dpdGNoPjwvZz48cmVjdCB4PSIxMTUiIHk9IjEwMSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDEyNnB4OyBtYXJnaW4tbGVmdDogMTE2cHg7Ij48ZGl2IGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogYWxsOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij5HaXRsYWIgQ0k8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMTQ1IiB5PSIxMzAiIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgZm9udC1zaXplPSIxMnB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5HaXRsYWIgQ0k8L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gMjMxIDI2IEwgMTgyLjc0IDI2IiBmaWxsPSJub25lIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSAxNzYuNzQgMjYgTCAxODQuNzQgMjIgTCAxODIuNzQgMjYgTCAxODQuNzQgMzAgWiIgZmlsbD0iIzAwN2ZmZiIgc3Ryb2tlPSIjMDA3ZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxyZWN0IHg9IjIzMSIgeT0iMSIgd2lkdGg9IjYwIiBoZWlnaHQ9IjUwIiByeD0iNy41IiByeT0iNy41IiBmaWxsPSIjZGFlOGZjIiBzdHJva2U9IiMwMDdmZmYiIHN0cm9rZS13aWR0aD0iMiIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3QgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiA1OHB4OyBoZWlnaHQ6IDFweDsgcGFkZGluZy10b3A6IDI2cHg7IG1hcmdpbi1sZWZ0OiAyMzJweDsiPjxkaXYgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiIHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBhbGw7IHdoaXRlLXNwYWNlOiBub3JtYWw7IG92ZXJmbG93LXdyYXA6IG5vcm1hbDsiPkFuc2libGU8YnIgLz5BV1g8L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iMjYxIiB5PSIzMCIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkFuc2libGUuLi48L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+Vmlld2VyIGRvZXMgbm90IHN1cHBvcnQgZnVsbCBTVkcgMS4xPC90ZXh0PjwvYT48L3N3aXRjaD48L3N2Zz4=" width="292" height="152" class="img_E7b_"></p><p>Gitlab will be used by the solution for 3 main objectives:</p><ul><li><strong>Store structured data that will be read and manipulated by the API, also keeping historical data/versions.</strong> This is it purpose on architecture.</li><li>Store inventories, playbooks and complementary files (templates, etc.) used by AWX. (Could be files directed inserted on AWX)</li><li>Store the APIs and UI code. (Could be files directed created on a web server infrastructure)</li></ul><p>Ideally, for security purposes, you should separate it in 3 or 2 gitlabs (1 only for AWX files, <strong>1 for your structured data</strong> (our main reason) and 1 for APIs/UI). Gitlab-ci/runner should communicate only with structured data gitlab and maybe APIs/UI gitlab. For simplicity on the demo, will be kept only one.</p><p>On full-stack automation, gitlab never talks to any external element and only receives connection from the following elements:</p><ul><li>APIs that need to read/write structured data on repositories.</li><li>Gitlab CI that reads pour structured data and starts the execution of a pipeline and call AWX to implement changes.</li><li>AWX that needs to read playbooks/inventories/templates (could be a separate gitlab).</li></ul><p>You may also need to manually send data to it (eg.: modify API source codes or ansible playbooks). Also it could be used to make a request/approval step for gitlab runner pipeline and 'admins/operators' can access it and approve this step directly on gitlab web UI.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-alternatives">Gitlab Alternatives<a class="hash-link" href="#gitlab-alternatives" title="Direct link to heading">​</a></h2><p>As any other piece of the solution you could replace gitlab with other tools, like github, files, databases or whatever. Also, for the structured data for your API, you could use other specific solutions that should work even better than gitlab.</p><p>You could use <a href="https://netbox.readthedocs.io/en/stable/" target="_blank" rel="noopener noreferrer">Netbox</a> which already has a lot of structured data and a nice API, but it's a little difficult to expand (as of 2021-12). You could also use <a href="https://docs.python-eve.org/en/stable/" target="_blank" rel="noopener noreferrer">Python Eve</a> which is a data agnostic API interface to a mongodb with features like data validation and format, auto sort/filter, historical data and included race conditions control. Really nice solution and fits perfectly on this architecture. Go check it out.</p><p>Remember that changing gitlab with another solution will need adjustment on the CI/CD portion. You can add an MQ (eg.: activeMQ, rabbitMQ) to the architecture that would make you less dependent on gitlab CI and make gitlab more easily replaceable. MQ would be the mechanism that calls AWX and monitor execution (instead of gitlab-ci), and the API itself would post jobs on the MQ. This would also allow you to insert other automations tools besides AWX, since the MQ would be the solution that calls jobs and monitors its execution. It is a good option also.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="gitlab-install-config">Gitlab Installation and Configuration<a class="hash-link" href="#gitlab-install-config" title="Direct link to heading">​</a></h2><p>First, if you haven't cloned the architecture repo from github, please do so: <code>git clone https://github.com/liviozanol/full-stack-automation</code></p><p>TL;DR: Simply run the shell script. You could check each step reading the <a href="https://github.com/liviozanol/full-stack_automation/tree/master/installation/gitlab" target="_blank" rel="noopener noreferrer">repo itself</a></p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo /bin/bash installation/gitlab/create_gitlab.sh</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>You need to have docker and docker-compose available. Docker service must be running and healthy (check with <code>sudo docker ps</code> or similar).</p></div></div><p>The installation has a docker-compose YAML and a shell script. The shell script is used to create users and access tokens on gitlab that will be used by AWX to get playbooks and also for further scripts to associate gitlab-ci to projects programmatically (and also create the repositories). Note that we are running gitlab only on HTTP. In a production environment you should run it on HTTPS (offloaded or not).</p><p>The docker-compose will install and run gitlab and also run a shell script that will create users access tokens to be used further on the solution.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="python eve" term="python eve"/>
        <category label="netbox" term="netbox"/>
        <category label="gitlab-ci" term="gitlab-ci"/>
        <category label="network automation" term="network automation"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Full-Stack Automation Part 1 - Overview]]></title>
        <id>full-stack-it-automation-part-1</id>
        <link href="https://livio.zanol.com.br/full-stack-it-automation-part-1"/>
        <updated>2021-12-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Introduction]]></summary>
        <content type="html"><![CDATA[<h2 class="anchor anchorWithStickyNavbar_mojV" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>So, this is the first post on a series of automation posts that will demonstrate how to build a Full-Stack automation. In fact it can be used to automate any service, but we'll focus and use network as an example.</p><p>This first post will cover the idea of the solution, its architecture, components and other useful information. I'll try my best to not use marketing or specific definitions like SD-WAN, SDN, SaaS, IaaS, etc.</p><p>First of all, let's be clear about what is considered "full-stack automation" regarding this series of posts. Full-stack automation is referred as a solution/architecture to fully automate network (or any other services), beginning on the automation itself (eg.: playbooks that will run commands on a Automated Resource) all the way up to a structured data source using gitlab, an API and a WEB interface to be used by final users of the solution.</p><p>After building all this architecture, users should be able to access a page, input some information/value in it (eg.: routes, acls, interfaces IP address, etc.) and watch it being deployed by ansible on a Automated Resource (eg.: router)</p><p><img loading="lazy" alt="Full-stack Auto GIF" src="/assets/images/full-auto-ce636b1d21e492560d669907a05839ea.gif" width="983" height="434" class="img_E7b_"></p><p><strong>If you are on a hurry and don't want to read further, the installation scripts and demo can be found in this repository</strong>: <a href="https://github.com/liviozanol/full-stack_automation" target="_blank" rel="noopener noreferrer">https://github.com/liviozanol/full-stack_automation</a>.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="the-architecture">The Architecture<a class="hash-link" href="#the-architecture" title="Direct link to heading">​</a></h2><p>The architecture presented in this series of posts, which is shown below, is intended to be agnostic of manufacturer and cover any service automation, in a structured, secure and scalable way. Each piece was thought of in a way that can be exchanged by another solution with little/no adjustment on other pieces. You could change gitlab for files, change hashicorp vault for ansible secrets, change the API programming language to any other that you want, change the web user interface for other you want.</p><p><img loading="lazy" alt="Architecture of Full-Stack Automation" src="/assets/images/architecture_dark-1cfd6a6e36d1fd3337b3a6240a0f2217.svg" width="627" height="242" class="img_E7b_"></p><p><strong>This series of posts will detail every layer/element of the architecture, also providing a guide on how to install and configure each one of them. In the end you should have a complete functional Full-Stack Automation solution based on this architecture and also a demo.</strong></p><p>Description of each element/layer:</p><ul><li><p>The web interface will provide a friendly interface to users where they can list, create, update or delete data from a browser.</p></li><li><p>The API will provide a single point of contact for all automation and is responsible to receive user requests on data modifications (eg.: change network interface ip address), validate the data and send it to gitlab.</p></li><li><p>Gitlab is used as a place to store structured data from users (like a database), and also ansible playbooks.</p></li><li><p>Gitlab-CI/Runner will listen for data modifications on gitlab and call AWX to execute playbooks.</p></li><li><p>AWX/ansible will execute playbooks to implement the data modified by users in Automated Resources.</p></li><li><p>Hashicorp Vault will store key/pass to access Automated Resources and also key/pass to interact between elements (git lab token, etc.).</p></li><li><p>Automated Resource is a piece of infrastructure that provides some IT service. It can be a router/switch, a firewall, a hypervisor (eg.: vmware vsphere, openstack), a virtual machine, a container, etc. A router will be used as an example. Since we are using ansible, almost anything can be automated. You can even manage a terraform deployment to extend it even further (<a href="https://docs.ansible.com/ansible/latest/collections/community/general/terraform_module.html" target="_blank" rel="noopener noreferrer">https://docs.ansible.com/ansible/latest/collections/community/general/terraform_module.html</a>)! The resource is <em>only accessed by ansible</em> and using credentials stored in a specific Hashicorp Vault. You can also use other middle/tunnel/bastion infrastructure to access the Automated Resource through ansible, like a SSH tunnel.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-use-archtecture">Why/When to use Full-Stack Automation?<a class="hash-link" href="#why-use-archtecture" title="Direct link to heading">​</a></h2><p>When you have services/functions that needs to be used by final users to manage a provided infrastructure by you. Examples:</p><ul><li><p>You are a cloud provider and your users needs a portal/API/console/terraform module to manage the infrastructure you provide (just like current cloud providers: AWS, Azure, Google Cloud, Digital Ocean, etc.);</p></li><li><p>You are a service provider and you want(or need) that your users be able to change some configurations remotely for the provided infrastructured using a portal/API. (eg.: create ACLs on a remote CPE router you provide for them)</p></li><li><p>You have an operation team and you want to provide a portal/API to operators to provise or change infrastructure. (eg.: install and manage CPEs on a WAN network)</p></li><li><p>You just want to test the architecture or learn more about automation.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="why-not-use-archtecture">Why/When <em>NOT</em> use Full-Stack Automation?<a class="hash-link" href="#why-not-use-archtecture" title="Direct link to heading">​</a></h2><p>When you don't need/want to provide infrastructure services in a self-service manner to the end user or When you have a small team that can manage the infrastructure directly.</p><p>Either way, the architecture designed can also be used for any cases on any element. You can, for example, just provide access to gitlab files and let your technical team modify direct information (a.k.a gitops) and leverage on the CI/CD + AWX solutions to implement it on your infrastructure. You can also provide direct access to AWX so operators just complete a web form (like a normal AWX use).</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="automation-scenario">Automation Scenario Used<a class="hash-link" href="#automation-scenario" title="Direct link to heading">​</a></h2><p>We will use a scenario as an example to implement a demo for the Full-Stack Automation architecture described here.</p><p>Assertions:</p><p>You work on a network service provider that serves WAN connections to several clients.</p><p>The network topology has CPEs (routers installed on clients premises) for every remote site that is connected to the provider network and that router connects each client site LAN to your transport network. You are required to allow clients to modify some configurations on these CPEs.</p><ul><li><p>Clients should be able to change configuration for all CPEs installed on their remote sites.</p></li><li><p>Clients must only modify configuration for the LAN interface of CPEs.</p></li><li><p>Clients should be able to modify configuration for interface description, interface IP address/subnet, interface ACLs and helper address/dhcp relay (DHCP server address).</p></li><li><p>Clients should be able to access a web page to make modifications. They should be able to also do these actions through an API.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="system-requirements">System Requirements<a class="hash-link" href="#system-requirements" title="Direct link to heading">​</a></h2><p>The simulated architecture will run on a single machine. In a production environment you may need to adjust it by separating elements in different secure segments and adding one or more pieces of softwares as needed.</p><p>Since it's on a single machine you'll need some good amount of <strong>FREE</strong> RAM memory (around 8GB), around 20GB of free disk space and a decent CPU. Since this is a demo, you have the option to use gitlab.com (or other gitlab) instead of intalling one and save about 3-4GB of RAM, be needs to adjust the steps/scripts.</p><p>It'll be used docker-compose and some custom scripts to build the solution. You could install it using pure docker or kubernetes, adjusting scripts and files, of course.</p><p>You can run the scripts on a VM using a virtual box, another hypervisor (vmware, 'aws', openstack, etc) or use WSL on windows (which is also a VM by the way). Running the demo on a VM is a nice option.</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="automation" term="automation"/>
        <category label="awx" term="awx"/>
        <category label="ansible" term="ansible"/>
        <category label="gitlab" term="gitlab"/>
        <category label="network automation" term="network automation"/>
        <category label="gitops" term="gitops"/>
        <category label="CI/CD" term="CI/CD"/>
        <category label="ops pipeline" term="ops pipeline"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[First Post]]></title>
        <id>first</id>
        <link href="https://livio.zanol.com.br/first"/>
        <updated>2021-11-26T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Just a first page to keep a record (a.k.a "Hello World")!]]></summary>
        <content type="html"><![CDATA[<p>Just a first page to keep a record (a.k.a "Hello World")!</p>]]></content>
        <author>
            <name>Lívio Zanol Puppim</name>
            <uri>https://github.com/liviozanol</uri>
        </author>
        <category label="first" term="first"/>
        <category label="hello world" term="hello world"/>
        <category label="docusaurus" term="docusaurus"/>
    </entry>
</feed>